<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ZapSan ⚡ Acesso</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #25D366;
      --primary-hover: #128C7E;
      --surface: #1a1a1a;
      --surface-variant: #2a2a2a;
      --on-surface: #ffffff;
      --on-surface-variant: #9ca3af;
      --outline: #374151;
      --error: #ef4444;
      --success: #10b981;
      --glass-bg: rgba(26, 26, 26, 0.7);
      --glass-border: rgba(255, 255, 255, 0.1);
      --shadow-light: rgba(255, 255, 255, 0.05);
      --shadow-dark: rgba(0, 0, 0, 0.4);
      --radius: 16px;
      --font: 'Inter', system-ui, -apple-system, sans-serif;
    }

    [data-theme="light"] {
      --surface: #ffffff;
      --surface-variant: #f8fafc;
      --on-surface: #1f2937;
      --on-surface-variant: #6b7280;
      --outline: #e5e7eb;
      --glass-bg: rgba(255, 255, 255, 0.8);
      --glass-border: rgba(0, 0, 0, 0.08);
      --shadow-light: rgba(255, 255, 255, 0.8);
      --shadow-dark: rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font);
      background: linear-gradient(135deg, var(--surface) 0%, var(--surface-variant) 100%);
      color: var(--on-surface);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-x: hidden;
    }

    /* Animated background pattern */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(37, 211, 102, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(18, 140, 126, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(37, 211, 102, 0.05) 0%, transparent 50%);
      z-index: -1;
      animation: backgroundShift 20s ease-in-out infinite alternate;
    }

    @keyframes backgroundShift {
      0% { transform: translate(-10px, -10px) scale(1); }
      100% { transform: translate(10px, 10px) scale(1.05); }
    }

    .login-container {
      width: 100%;
      max-width: 420px;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 48px 32px;
      box-shadow: 
        0 20px 25px -5px var(--shadow-dark),
        0 10px 10px -5px rgba(0, 0, 0, 0.04),
        inset 0 1px 0 var(--shadow-light);
      animation: containerSlideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
    }

    @keyframes containerSlideUp {
      0% {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Header com logo */
    .header {
      text-align: center;
      margin-bottom: 32px;
    }

    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .logo-text {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.025em;
    }

    .subtitle {
      font-size: 15px;
      color: var(--on-surface-variant);
      font-weight: 400;
    }

    /* Theme toggle */
    .theme-toggle {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      border: none;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 18px;
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.05);
    }

    /* Form styles */
    .form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      position: relative;
    }

    .form-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--on-surface);
      margin-bottom: 8px;
      display: block;
    }

    .form-input {
      width: 100%;
      height: 52px;
      background: var(--surface);
      border: 1.5px solid var(--outline);
      border-radius: 12px;
      padding: 0 16px;
      font-size: 16px;
      font-family: inherit;
      color: var(--on-surface);
      transition: all 0.2s ease;
    }

    .form-input::placeholder {
      color: var(--on-surface-variant);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
      transform: translateY(-1px);
    }

    .form-input:hover:not(:focus) {
      border-color: var(--on-surface-variant);
    }

    /* Error states */
    .form-input.error {
      border-color: var(--error);
      background: rgba(239, 68, 68, 0.05);
    }

    .form-input.error:focus {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }

    /* Success states */
    .form-input.success {
      border-color: var(--success);
    }

    .form-input.success:focus {
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    /* Password input wrapper */
    .password-wrapper {
      position: relative;
    }

    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s ease;
      opacity: 0.6;
    }

    .password-toggle:hover {
      opacity: 1;
      background: rgba(255, 255, 255, 0.05);
    }

    /* Button */
    .btn-primary {
      width: 100%;
      height: 52px;
      background: var(--primary);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 4px 15px rgba(37, 211, 102, 0.2);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Loading spinner */
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mode toggle */
    .mode-toggle {
      text-align: center;
      margin-top: 24px;
      font-size: 14px;
      color: var(--on-surface-variant);
    }

    .mode-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mode-link:hover {
      opacity: 0.8;
      text-decoration: underline;
    }

    /* Alert messages */
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 20px;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .alert.show {
      opacity: 1;
      transform: translateY(0);
    }

    .alert.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: #fca5a5;
    }

    .alert.success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: #6ee7b7;
    }

    /* Hidden fields for register mode */
    .register-fields {
      display: none;
      flex-direction: column;
      gap: 20px;
      margin-top: 20px;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .register-fields.show {
      display: flex;
      opacity: 1;
      transform: translateY(0);
    }

    /* Footer */
    .footer {
      text-align: center;
      margin-top: 32px;
      font-size: 12px;
      color: var(--on-surface-variant);
      opacity: 0.7;
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
      .login-container {
        margin: 0;
        padding: 32px 24px;
        border-radius: 0;
        height: 100vh;
        justify-content: center;
        display: flex;
        flex-direction: column;
      }
      
      body {
        padding: 0;
      }
    }

    /* Focus-visible support */
    .form-input:focus-visible,
    .btn-primary:focus-visible,
    .theme-toggle:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="login-container">
    <button class="theme-toggle" id="themeToggle" aria-label="Alternar tema">
      🌙
    </button>
    
    <div class="header">
      <div class="logo">
        <div class="logo-icon">⚡</div>
        <div class="logo-text">ZapSan</div>
      </div>
      <div class="subtitle" id="subtitle">Faça login para continuar</div>
    </div>

    <div class="alert error" id="errorAlert" role="alert" aria-live="polite"></div>
    <div class="alert success" id="successAlert" role="alert" aria-live="polite"></div>

    <form class="form" id="authForm" novalidate>
      <div class="form-group">
        <label class="form-label" for="email">Email</label>
        <input 
          class="form-input" 
          type="email" 
          id="email" 
          name="email" 
          placeholder="seu@email.com"
          autocomplete="email"
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label" for="password">Senha</label>
        <div class="password-wrapper">
          <input 
            class="form-input" 
            type="password" 
            id="password" 
            name="password"
            placeholder="••••••••"
            autocomplete="current-password"
            required
          />
          <button type="button" class="password-toggle" id="passwordToggle" aria-label="Mostrar senha">
            👁️
          </button>
        </div>
      </div>

      <div class="register-fields" id="registerFields">
        <div class="form-group">
          <label class="form-label" for="name">Nome completo</label>
          <input 
            class="form-input" 
            type="text" 
            id="name" 
            name="name"
            placeholder="Seu nome"
            autocomplete="name"
          />
        </div>

        <div class="form-group">
          <label class="form-label" for="confirmPassword">Confirmar senha</label>
          <div class="password-wrapper">
            <input 
              class="form-input" 
              type="password" 
              id="confirmPassword" 
              name="confirmPassword"
              placeholder="••••••••"
              autocomplete="new-password"
            />
            <button type="button" class="password-toggle" id="confirmToggle" aria-label="Mostrar senha">
              👁️
            </button>
          </div>
        </div>
      </div>

      <button type="submit" class="btn-primary" id="submitBtn">
        <span id="btnText">Entrar</span>
      </button>
    </form>

    <div class="mode-toggle">
      <span id="modeText">Não tem conta?</span>
      <a class="mode-link" id="modeLink" href="#">Criar uma agora</a>
    </div>

    <div class="footer">
      ZapSan • WhatsApp Business Platform
    </div>
  </div>

  <script src="/security-utils.js"></script>
  <script>
    // Application state
    let isLoginMode = true
    let isLoading = false

    // DOM elements
    const form = document.getElementById('authForm')
    const subtitle = document.getElementById('subtitle')
    const submitBtn = document.getElementById('submitBtn')
    const btnText = document.getElementById('btnText')
    const modeText = document.getElementById('modeText')
    const modeLink = document.getElementById('modeLink')
    const registerFields = document.getElementById('registerFields')
    const errorAlert = document.getElementById('errorAlert')
    const successAlert = document.getElementById('successAlert')
    const themeToggle = document.getElementById('themeToggle')
    
    // Form inputs
    const emailInput = document.getElementById('email')
    const passwordInput = document.getElementById('password')
    const nameInput = document.getElementById('name')
    const confirmPasswordInput = document.getElementById('confirmPassword')
    const passwordToggle = document.getElementById('passwordToggle')
    const confirmToggle = document.getElementById('confirmToggle')

    // Initialize app
    function init() {
      setupEventListeners()
      setupTheme()
      validateAuthRedirect()
    }

    function setupEventListeners() {
      // Form submission
      form.addEventListener('submit', handleSubmit)
      
      // Mode toggle
      modeLink.addEventListener('click', (e) => {
        e.preventDefault()
        toggleMode()
      })
      
      // Password visibility toggles
      passwordToggle.addEventListener('click', () => togglePasswordVisibility('password'))
      confirmToggle.addEventListener('click', () => togglePasswordVisibility('confirmPassword'))
      
      // Real-time validation
      emailInput.addEventListener('input', () => validateField(emailInput, 'email'))
      passwordInput.addEventListener('input', () => validateField(passwordInput, 'password'))
      nameInput.addEventListener('input', () => validateField(nameInput, 'name'))
      confirmPasswordInput.addEventListener('input', () => validateField(confirmPasswordInput, 'confirmPassword'))
      
      // Theme toggle
      themeToggle.addEventListener('click', toggleTheme)
      
      // Enter key handling
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey && document.activeElement.tagName === 'INPUT') {
          e.preventDefault()
          form.requestSubmit()
        }
      })
    }

    function toggleMode() {
      isLoginMode = !isLoginMode
      
      if (isLoginMode) {
        // Switch to login mode
        subtitle.textContent = 'Faça login para continuar'
        btnText.textContent = 'Entrar'
        modeText.textContent = 'Não tem conta?'
        modeLink.textContent = 'Criar uma agora'
        registerFields.classList.remove('show')
        passwordInput.setAttribute('autocomplete', 'current-password')
      } else {
        // Switch to register mode
        subtitle.textContent = 'Crie sua conta'
        btnText.textContent = 'Criar conta'
        modeText.textContent = 'Já tem conta?'
        modeLink.textContent = 'Fazer login'
        registerFields.classList.add('show')
        passwordInput.setAttribute('autocomplete', 'new-password')
      }
      
      hideAlerts()
      clearValidationStates()
    }

    function togglePasswordVisibility(fieldId) {
      const field = document.getElementById(fieldId)
      const toggle = fieldId === 'password' ? passwordToggle : confirmToggle
      
      if (field.type === 'password') {
        field.type = 'text'
        toggle.textContent = '🙈'
        toggle.setAttribute('aria-label', 'Ocultar senha')
      } else {
        field.type = 'password'
        toggle.textContent = '👁️'
        toggle.setAttribute('aria-label', 'Mostrar senha')
      }
    }

    function validateField(input, type) {
      const value = input.value.trim()
      let isValid = true
      
      switch (type) {
        case 'email':
          isValid = validateEmail(value)
          break
        case 'password':
          isValid = value.length >= 8
          break
        case 'name':
          isValid = value.length >= 2
          break
        case 'confirmPassword':
          isValid = value === passwordInput.value
          break
      }
      
      input.classList.remove('error', 'success')
      if (value) {
        input.classList.add(isValid ? 'success' : 'error')
      }
      
      return isValid
    }

    function validateEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email) && email.length <= 255
    }

    function clearValidationStates() {
      document.querySelectorAll('.form-input').forEach(input => {
        input.classList.remove('error', 'success')
      })
    }

    async function handleSubmit(e) {
      e.preventDefault()
      
      if (isLoading) return
      
      hideAlerts()
      
      // Validate all fields
      const emailValid = validateField(emailInput, 'email')
      const passwordValid = validateField(passwordInput, 'password')
      let nameValid = true
      let confirmValid = true
      
      if (!isLoginMode) {
        nameValid = validateField(nameInput, 'name')
        confirmValid = validateField(confirmPasswordInput, 'confirmPassword')
      }
      
      if (!emailValid || !passwordValid || !nameValid || !confirmValid) {
        showAlert('Por favor, corrija os campos destacados', 'error')
        return
      }
      
      // Rate limiting
      if (!rateLimiter.canMakeRequest('auth')) {
        const remaining = Math.ceil(rateLimiter.getRemainingTime('auth') / 1000)
        showAlert(`Muitas tentativas. Aguarde ${remaining}s`, 'error')
        return
      }
      
      setLoading(true)
      
      try {
        const payload = {
          email: sanitizeInput(emailInput.value.trim(), 'email'),
          password: passwordInput.value
        }
        
        if (!isLoginMode) {
          payload.name = sanitizeInput(nameInput.value.trim(), 'name')
          payload.confirm = confirmPasswordInput.value
        }
        
        // Additional security validation
        if (payload.email.length > 255 || payload.password.length > 128) {
          throw new Error('Dados muito longos')
        }
        
        if (/[<>'"&]/.test(payload.email) || (payload.name && /[<>'"&]/.test(payload.name))) {
          throw new Error('Caracteres inválidos detectados')
        }
        
        const endpoint = isLoginMode ? '/auth/login' : '/auth/register'
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        
        const result = await response.json()
        
        if (!response.ok) {
          throw new Error(result.message || result.error || `Erro ${response.status}`)
        }
        
        // Success - store auth data
        try {
          localStorage.setItem('auth', 'ok')
          if (result.sessionId) {
            localStorage.setItem('sessionId', result.sessionId)
            localStorage.setItem('session_id', result.sessionId)
          }
          if (result.user?.id) {
            localStorage.setItem('userId', result.user.id)
          }
        } catch (storageError) {
          console.warn('Failed to store auth data:', storageError)
        }
        
        showAlert(isLoginMode ? 'Login realizado com sucesso!' : 'Conta criada com sucesso!', 'success')
        
        // Redirect after short delay
        setTimeout(() => {
          const sessionId = result.sessionId || localStorage.getItem('sessionId')
          const redirectUrl = sessionId 
            ? `/?session_id=${encodeURIComponent(sessionId)}` 
            : '/'
          window.location.replace(redirectUrl)
        }, 1500)
        
      } catch (error) {
        console.error('Auth error:', error)
        showAlert(error.message || 'Erro de conexão. Tente novamente.', 'error')
      } finally {
        setLoading(false)
      }
    }

    function setLoading(loading) {
      isLoading = loading
      submitBtn.disabled = loading
      
      if (loading) {
        btnText.innerHTML = '<div class="loading-spinner"></div>'
      } else {
        btnText.textContent = isLoginMode ? 'Entrar' : 'Criar conta'
      }
    }

    function showAlert(message, type) {
      hideAlerts()
      const alert = type === 'error' ? errorAlert : successAlert
      alert.textContent = message
      alert.classList.add('show')
      
      if (type === 'success') {
        setTimeout(hideAlerts, 5000)
      }
    }

    function hideAlerts() {
      errorAlert.classList.remove('show')
      successAlert.classList.remove('show')
    }

    // Theme management
    function setupTheme() {
      const savedTheme = localStorage.getItem('theme') || 
        (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark')
      applyTheme(savedTheme)
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme')
      const newTheme = currentTheme === 'light' ? 'dark' : 'light'
      applyTheme(newTheme)
      localStorage.setItem('theme', newTheme)
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme)
      themeToggle.textContent = theme === 'light' ? '🌙' : '☀️'
      themeToggle.setAttribute('aria-label', `Usar tema ${theme === 'light' ? 'escuro' : 'claro'}`)
    }

    // Auth redirect check
    function validateAuthRedirect() {
      try {
        const hasAuth = localStorage.getItem('auth') === 'ok'
        if (hasAuth) {
          // Validate with server
          fetch('/me/profile')
            .then(response => {
              if (response.ok) {
                return response.json()
              }
              throw new Error('Auth validation failed')
            })
            .then(data => {
              const sessionId = data.sessionId || localStorage.getItem('sessionId')
              const redirectUrl = sessionId 
                ? `/?session_id=${encodeURIComponent(sessionId)}` 
                : '/'
              window.location.replace(redirectUrl)
            })
            .catch(() => {
              localStorage.removeItem('auth')
            })
        }
      } catch (error) {
        console.warn('Auth redirect check failed:', error)
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init)
    } else {
      init()
    }
  </script>
</body>
</html>