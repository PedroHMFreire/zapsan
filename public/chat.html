<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZapSan ‚ö° Chat</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/mobile-enhancements.css" />
  <link rel="stylesheet" href="/mobile-fixes.css" />
  <script>(function(){try{const a=localStorage.getItem('auth')==='ok';const onL=location.pathname.endsWith('/login.html');if(!a&&!onL){location.replace('/login.html');}if(a&&onL){location.replace('/');}}catch(e){}})();</script>
</head>
<body>
  <header>
    <h1>Chat do Bot</h1>
    <div class="ai-control">
      <button id="aiToggle" class="btn ai-btn">
        <span class="ai-status">ü§ñ IA: <span id="aiStatusText">Carregando...</span></span>
      </button>
    </div>
  </header>
  <div class="container">
    <div class="card chat">
      <div class="messages" id="messages"></div>
      <div>
        <label>Seu n√∫mero (com DDI/DDD, ex.: 5598999999999)</label>
        <input id="to" placeholder="5598XXXXXXXXX" />
        <div class="row" style="margin-top:6px">
          <input id="text" placeholder="Escreva uma mensagem..." />
          <button class="btn" id="send">Enviar</button>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:12px;color:#8696a0;">
          <span>Pressione Enter para enviar</span>
          <span id="char-counter">0/4096</span>
        </div>
      </div>
    </div>
  </div>
  <script src="/security-utils.js"></script>
  <script>
    let session_id = null;
    let aiEnabled = true; // Estado local da IA
    
    const list = document.getElementById('messages');
    const to = document.getElementById('to');
    const text = document.getElementById('text');
    const sendBtn = document.getElementById('send');
    const aiToggleBtn = document.getElementById('aiToggle');
    const aiStatusText = document.getElementById('aiStatusText');
    
    async function resolveSession(){
      try {
        session_id = localStorage.getItem('sessionId') || null;
        if(!session_id){
          // tenta obter via /me/session (cookie uid httpOnly)
          const r = await fetch('/me/session');
          if(r.ok){ const j = await r.json(); session_id = j.sessionId; localStorage.setItem('sessionId', session_id); }
        }
        if(session_id){ 
          startStream(); 
          loadAIStatus(); // Carregar status da IA
        }
      } catch{}
    }
    
    // ü§ñ Controle da IA
    async function loadAIStatus() {
      try {
        const r = await fetch('/me/session/ai/status');
        if (r.ok) {
          const data = await r.json();
          aiEnabled = data.aiEnabled;
          updateAIButton();
        }
      } catch (error) {
        console.warn('Erro ao carregar status da IA:', error);
        aiStatusText.textContent = 'Erro';
      }
    }
    
    function updateAIButton() {
      const status = aiEnabled ? 'Ativa' : 'Desabilitada';
      const color = aiEnabled ? '#4CAF50' : '#f44336';
      
      aiStatusText.textContent = status;
      aiToggleBtn.style.backgroundColor = color;
      aiToggleBtn.title = aiEnabled 
        ? 'IA est√° ativa - Clique para desabilitar (atendente assume)'
        : 'IA desabilitada - Clique para reativar';
    }
    
    async function toggleAI() {
      try {
        aiToggleBtn.disabled = true;
        aiStatusText.textContent = 'Alterando...';
        
        const r = await fetch('/me/session/ai/toggle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled: !aiEnabled })
        });
        
        if (r.ok) {
          const data = await r.json();
          aiEnabled = data.aiEnabled;
          updateAIButton();
          
          // Mostrar notifica√ß√£o na conversa
          const action = aiEnabled ? 'ativada' : 'desabilitada';
          const who = aiEnabled ? 'IA assumir√° as pr√≥ximas mensagens' : 'Atendente deve responder manualmente';
          pushMsg('system', `ü§ñ IA ${action}. ${who}`);
          
        } else {
          const error = await r.json().catch(() => ({}));
          pushMsg('system', `‚ùå Erro: ${error.message || 'Falha ao alterar IA'}`);
        }
      } catch (error) {
        pushMsg('system', `‚ùå Erro de conex√£o: ${error.message}`);
      } finally {
        aiToggleBtn.disabled = false;
      }
    }
    
    // Event listeners
    aiToggleBtn.onclick = toggleAI;
    
    // Enter para enviar mensagem
    text.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });
    
    // Valida√ß√£o em tempo real
    to.addEventListener('input', (e) => {
      const value = e.target.value;
      const isValid = validateInput(value, 'phone');
      e.target.style.borderColor = value && !isValid ? '#f44336' : '';
    });
    
    text.addEventListener('input', (e) => {
      const value = e.target.value;
      const isValid = validateInput(value, 'message', 4096);
      e.target.style.borderColor = value && !isValid ? '#f44336' : '';
      
      // Contador de caracteres
      const counter = document.getElementById('char-counter');
      if (counter) {
        counter.textContent = `${value.length}/4096`;
        counter.style.color = value.length > 4000 ? '#f44336' : '#8696a0';
      }
    });
    
    resolveSession();

    function pushMsg(who, content) {
      const el = document.createElement('div');
      
      if (who === 'system') {
        el.className = 'msg system';
        // Para mensagens do sistema, usar sanitiza√ß√£o
        safeSetHTML(el, content);
      } else {
        el.className = 'msg ' + (who === 'me' ? 'me' : 'bot');
        // Para mensagens normais, sempre usar textContent
        safeSetInnerHTML(el, content);
      }
      
      list.appendChild(el);
      list.scrollTop = list.scrollHeight;
    }

    function ingestInitial(messages){
      if(!Array.isArray(messages)) return
      // ordenar por timestamp asc
      messages.sort((a,b)=> (a.timestamp||0)-(b.timestamp||0))
      for(const m of messages){
        pushMsg(m.fromMe ? 'me' : 'bot', m.text || '[sem texto]')
      }
    }

    let currentES = null;
    function clearMessages(){ list.innerHTML=''; }
    function startStream(){
      if(!session_id){ return }
      if(currentES){ try{ currentES.close() }catch{} }
      const es = new EventSource(`/sessions/${encodeURIComponent(session_id)}/stream`)
      currentES = es
      es.addEventListener('recent', ev => {
        try { const data = JSON.parse(ev.data); ingestInitial(data) } catch {}
      })
      es.addEventListener('message', ev => {
        try { const m = JSON.parse(ev.data); pushMsg(m.fromMe ? 'me' : 'bot', m.text || '[sem texto]') } catch {}
      })
      es.addEventListener('status', ev => {
        // Podemos futuramente exibir estado da sess√£o
      })
      es.onerror = () => {
        // tentativa simples de reconex√£o ap√≥s 3s
        try { es.close() } catch {}
        setTimeout(startStream, 3000)
      }
    }

  if(!session_id){ pushMsg('bot','Fazendo resolu√ß√£o da sess√£o...') }

    sendBtn.onclick = async () => {
      const toValue = to.value.trim();
      const textValue = text.value.trim();
      
      if (!session_id){ return alert('Sem sess√£o ativa. Refa√ßa o login.') }
      
      // Valida√ß√£o de entrada
      if (!toValue || !textValue) return alert('Preencha os campos');
      
      if (!validateInput(toValue, 'phone')) {
        return alert('N√∫mero de telefone inv√°lido. Use apenas n√∫meros.');
      }
      
      if (!validateInput(textValue, 'message', 4096)) {
        return alert('Mensagem inv√°lida ou muito longa (m√°x 4096 caracteres).');
      }
      
      // Rate limiting
      if (!rateLimiter.canMakeRequest('send-message')) {
        const remaining = Math.ceil(rateLimiter.getRemainingTime('send-message') / 1000);
        return alert(`Muitas mensagens. Aguarde ${remaining}s.`);
      }

      const payload = { to: toValue, text: textValue };
      pushMsg('me', payload.text);
      text.value = '';
      
      try {
        const r = await fetch('/messages/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!r.ok) {
          const j = await r.json().catch(()=>({}));
          pushMsg('bot', 'Erro: ' + (j.message || j.error || r.status));
        } else {
          // Como n√£o temos WebSocket, simulamos eco de entrega
          pushMsg('bot', 'Enviado! A resposta chegar√° no seu WhatsApp.');
        }
      } catch (error) {
        pushMsg('bot', 'Erro de conex√£o: ' + error.message);
      }
    };
  </script>
  
  <!-- Mobile Performance Scripts -->
  <script src="/virtual-scroller.js"></script>
  <script src="/lazy-loader.js"></script>
  <script src="/api-batch-manager.js"></script>
  <script src="/mobile-gestures.js"></script>
  <script src="/push-notifications.js"></script>
  
  <script>
    // Integra√ß√£o das otimiza√ß√µes m√≥veis
    document.addEventListener('DOMContentLoaded', () => {
      // Virtual scrolling para messages
      const messagesContainer = document.getElementById('messages')
      if (messagesContainer && window.VirtualMessageScroller) {
        const virtualScroller = new VirtualMessageScroller(messagesContainer, {
          itemHeight: 60,
          renderAhead: 10,
          enableInfiniteScroll: true
        })
        
        // Integrar com pushMsg
        const originalPushMsg = window.pushMsg
        window.pushMsg = function(who, content) {
          // Usar virtual scroller se dispon√≠vel
          if (virtualScroller) {
            virtualScroller.addMessage({ who, content, timestamp: Date.now() })
          } else {
            originalPushMsg(who, content)
          }
        }
      }
      
      // Otimizar envios com batching
      if (window.api) {
        const originalSend = sendBtn.onclick
        sendBtn.onclick = async () => {
          if (!session_id) { alert('Aguarde carregar sess√£o...'); return; }
          const payload = { session_id, to: to.value, text: text.value };
          if (!payload.to || !payload.text) return alert('Preencha os campos');
          
          pushMsg('me', payload.text);
          text.value = '';
          
          // Usar API batcher para melhor performance
          try {
            sendBtn.classList.add('api-loading')
            await window.api.post('/messages/send', payload)
            pushMsg('bot', 'Enviado! A resposta chegar√° no seu WhatsApp.');
          } catch (error) {
            pushMsg('bot', 'Erro: ' + error.message);
          } finally {
            sendBtn.classList.remove('api-loading')
          }
        }
      }
      
      // Touch gestures se dispon√≠vel
      if (window.MobileGestureHandler) {
        const gestureHandler = new MobileGestureHandler(document.body)
        
        // Pull to refresh
        gestureHandler.onPullToRefresh = () => {
          if (typeof resolveSession === 'function') {
            resolveSession()
          }
        }
        
        // Swipe para limpar chat
        gestureHandler.onSwipeRight = () => {
          if (confirm('Limpar conversa?')) {
            document.getElementById('messages').innerHTML = ''
          }
        }
      }
    })
  </script>
</body>
</html>