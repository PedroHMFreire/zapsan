<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZapSan • Chat</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/mobile-enhancements.css" />
  <link rel="stylesheet" href="/mobile-fixes.css" />
  <script>(function(){try{const a=localStorage.getItem('auth')==='ok';const onL=location.pathname.endsWith('/login.html');if(!a&&!onL){location.replace('/login.html');}if(a&&onL){location.replace('/');}}catch(e){}})();</script>
</head>
<body>
  <header><h1>Chat do Bot</h1></header>
  <div class="container">
    <div class="card chat">
      <div class="messages" id="messages"></div>
      <div>
        <label>Seu número (com DDI/DDD, ex.: 5598999999999)</label>
        <input id="to" placeholder="5598XXXXXXXXX" />
        <div class="row" style="margin-top:6px">
          <input id="text" placeholder="Escreva uma mensagem..." />
          <button class="btn" id="send">Enviar</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    let session_id = null;
    const list = document.getElementById('messages');
    const to = document.getElementById('to');
    const text = document.getElementById('text');
    const sendBtn = document.getElementById('send');
    async function resolveSession(){
      try {
        session_id = localStorage.getItem('sessionId') || null;
        if(!session_id){
          // tenta obter via /me/session (cookie uid httpOnly)
          const r = await fetch('/me/session');
          if(r.ok){ const j = await r.json(); session_id = j.sessionId; localStorage.setItem('sessionId', session_id); }
        }
        if(session_id){ startStream(); }
      } catch{}
    }
    resolveSession();

    function pushMsg(who, content) {
      const el = document.createElement('div');
      el.className = 'msg ' + (who === 'me' ? 'me' : 'bot');
      el.textContent = content;
      list.appendChild(el);
      list.scrollTop = list.scrollHeight;
    }

    function ingestInitial(messages){
      if(!Array.isArray(messages)) return
      // ordenar por timestamp asc
      messages.sort((a,b)=> (a.timestamp||0)-(b.timestamp||0))
      for(const m of messages){
        pushMsg(m.fromMe ? 'me' : 'bot', m.text || '[sem texto]')
      }
    }

    let currentES = null;
    function clearMessages(){ list.innerHTML=''; }
    function startStream(){
      if(!session_id){ return }
      if(currentES){ try{ currentES.close() }catch{} }
      const es = new EventSource(`/sessions/${encodeURIComponent(session_id)}/stream`)
      currentES = es
      es.addEventListener('recent', ev => {
        try { const data = JSON.parse(ev.data); ingestInitial(data) } catch {}
      })
      es.addEventListener('message', ev => {
        try { const m = JSON.parse(ev.data); pushMsg(m.fromMe ? 'me' : 'bot', m.text || '[sem texto]') } catch {}
      })
      es.addEventListener('status', ev => {
        // Podemos futuramente exibir estado da sessão
      })
      es.onerror = () => {
        // tentativa simples de reconexão após 3s
        try { es.close() } catch {}
        setTimeout(startStream, 3000)
      }
    }

  if(!session_id){ pushMsg('bot','Fazendo resolução da sessão...') }

    sendBtn.onclick = async () => {
  const payload = { to: to.value.trim(), text: text.value.trim() };
      if (!session_id){ return alert('Sem sessão ativa. Refaça o login.') }
      if (!payload.to || !payload.text) return alert('Preencha os campos');
      pushMsg('me', payload.text);
      text.value = '';
      const r = await fetch('/messages/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!r.ok) {
        const j = await r.json().catch(()=>({}));
        pushMsg('bot', 'Erro: ' + (j.error || r.status));
      } else {
        // Como não temos WebSocket, simulamos eco de entrega
        pushMsg('bot', 'Enviado! A resposta chegará no seu WhatsApp.');
      }
    };
  </script>
  
  <!-- Mobile Performance Scripts -->
  <script src="/virtual-scroller.js"></script>
  <script src="/lazy-loader.js"></script>
  <script src="/api-batch-manager.js"></script>
  <script src="/mobile-gestures.js"></script>
  <script src="/push-notifications.js"></script>
  
  <script>
    // Integração das otimizações móveis
    document.addEventListener('DOMContentLoaded', () => {
      // Virtual scrolling para messages
      const messagesContainer = document.getElementById('messages')
      if (messagesContainer && window.VirtualMessageScroller) {
        const virtualScroller = new VirtualMessageScroller(messagesContainer, {
          itemHeight: 60,
          renderAhead: 10,
          enableInfiniteScroll: true
        })
        
        // Integrar com pushMsg
        const originalPushMsg = window.pushMsg
        window.pushMsg = function(who, content) {
          // Usar virtual scroller se disponível
          if (virtualScroller) {
            virtualScroller.addMessage({ who, content, timestamp: Date.now() })
          } else {
            originalPushMsg(who, content)
          }
        }
      }
      
      // Otimizar envios com batching
      if (window.api) {
        const originalSend = sendBtn.onclick
        sendBtn.onclick = async () => {
          if (!session_id) { alert('Aguarde carregar sessão...'); return; }
          const payload = { session_id, to: to.value, text: text.value };
          if (!payload.to || !payload.text) return alert('Preencha os campos');
          
          pushMsg('me', payload.text);
          text.value = '';
          
          // Usar API batcher para melhor performance
          try {
            sendBtn.classList.add('api-loading')
            await window.api.post('/messages/send', payload)
            pushMsg('bot', 'Enviado! A resposta chegará no seu WhatsApp.');
          } catch (error) {
            pushMsg('bot', 'Erro: ' + error.message);
          } finally {
            sendBtn.classList.remove('api-loading')
          }
        }
      }
      
      // Touch gestures se disponível
      if (window.MobileGestureHandler) {
        const gestureHandler = new MobileGestureHandler(document.body)
        
        // Pull to refresh
        gestureHandler.onPullToRefresh = () => {
          if (typeof resolveSession === 'function') {
            resolveSession()
          }
        }
        
        // Swipe para limpar chat
        gestureHandler.onSwipeRight = () => {
          if (confirm('Limpar conversa?')) {
            document.getElementById('messages').innerHTML = ''
          }
        }
      }
    })
  </script>
</body>
</html>