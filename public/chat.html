<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZapSan • Chat</title>
  <link rel="stylesheet" href="/styles.css" />
  <script>(function(){try{const a=localStorage.getItem('auth')==='ok';const onL=location.pathname.endsWith('/login.html');if(!a&&!onL){location.replace('/login.html');}if(a&&onL){location.replace('/');}}catch(e){}})();</script>
</head>
<body>
  <header><h1>Chat do Bot</h1></header>
  <div class="container">
    <div class="card chat">
      <div class="messages" id="messages"></div>
      <div>
        <label>Seu número (com DDI/DDD, ex.: 5598999999999)</label>
        <input id="to" placeholder="5598XXXXXXXXX" />
        <div class="row" style="margin-top:6px">
          <input id="text" placeholder="Escreva uma mensagem..." />
          <button class="btn" id="send">Enviar</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    let session_id = null;
    const list = document.getElementById('messages');
    const to = document.getElementById('to');
    const text = document.getElementById('text');
    const sendBtn = document.getElementById('send');
    function resolveSession(){
      try { session_id = localStorage.getItem('sessionId') } catch {}
    }
    resolveSession()

    function pushMsg(who, content) {
      const el = document.createElement('div');
      el.className = 'msg ' + (who === 'me' ? 'me' : 'bot');
      el.textContent = content;
      list.appendChild(el);
      list.scrollTop = list.scrollHeight;
    }

    function ingestInitial(messages){
      if(!Array.isArray(messages)) return
      // ordenar por timestamp asc
      messages.sort((a,b)=> (a.timestamp||0)-(b.timestamp||0))
      for(const m of messages){
        pushMsg(m.fromMe ? 'me' : 'bot', m.text || '[sem texto]')
      }
    }

    let currentES = null;
    function clearMessages(){ list.innerHTML=''; }
    function startStream(){
      if(!session_id){ return }
      if(currentES){ try{ currentES.close() }catch{} }
      const es = new EventSource(`/sessions/${encodeURIComponent(session_id)}/stream`)
      currentES = es
      es.addEventListener('recent', ev => {
        try { const data = JSON.parse(ev.data); ingestInitial(data) } catch {}
      })
      es.addEventListener('message', ev => {
        try { const m = JSON.parse(ev.data); pushMsg(m.fromMe ? 'me' : 'bot', m.text || '[sem texto]') } catch {}
      })
      es.addEventListener('status', ev => {
        // Podemos futuramente exibir estado da sessão
      })
      es.onerror = () => {
        // tentativa simples de reconexão após 3s
        try { es.close() } catch {}
        setTimeout(startStream, 3000)
      }
    }

    if(session_id){ startStream() } else { pushMsg('bot','Faça login para inicializar a sessão.') }

    sendBtn.onclick = async () => {
      const payload = { to: to.value.trim(), text: text.value.trim() };
      if (!session_id){ return alert('Sem sessão ativa. Refaça o login.') }
      if (!payload.to || !payload.text) return alert('Preencha os campos');
      pushMsg('me', payload.text);
      text.value = '';
      const r = await fetch('/messages/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!r.ok) {
        const j = await r.json().catch(()=>({}));
        pushMsg('bot', 'Erro: ' + (j.error || r.status));
      } else {
        // Como não temos WebSocket, simulamos eco de entrega
        pushMsg('bot', 'Enviado! A resposta chegará no seu WhatsApp.');
      }
    };
  </script>
</body>
</html>