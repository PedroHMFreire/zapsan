<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sant√™ Console</title>
  <link rel="stylesheet" href="/styles.css" />
  <script>(function(){try{const a=localStorage.getItem('auth')==='ok';const onL=location.pathname.endsWith('/login.html');if(!a&&!onL){location.replace('/login.html');}if(a&&onL){location.replace('/');}}catch(e){}})();</script>
</head>
<body>
  <header class="topbar"><div class="topbar-inner">
    <div class="brand">Sant√™ Console</div>
    <nav class="menu">
      <button class="m-btn" id="menu-flow">Fluxo do chatbot</button>
      <button class="m-btn" id="menu-qr">Conectar QR</button>
      <button class="m-btn" id="menu-schedule">Agendar envios</button>
      <button class="m-btn" id="menu-tags">Etiquetar mensagem</button>
    </nav>
    <div class="badge" id="svc-badge">Carregando‚Ä¶</div>
  </div></header>

  <div class="app" id="app">
    <aside class="sidebar">
      <div class="s-header">
        <div class="brand" style="font-size:15px">Conversas</div>
        <div class="actions"><button class="icon-btn" id="new-chat">Ôºã</button></div>
      </div>
      <div class="s-search"><input class="input" id="search" placeholder="Pesquisar conversas‚Ä¶"></div>
      <div class="s-filters">
        <button class="chip is-active" data-filter="all">Todos</button>
        <button class="chip" data-filter="unread">N√£o lidas</button>
        <button class="chip" data-filter="starred">Com estrela</button>
      </div>
      <div class="chat-list" id="chat-list"></div>
    </aside>

    <section class="chat">
      <div class="c-header">
        <div class="peer">
          <button class="icon-btn" id="back" style="display:none">‚Üê</button>
          <div class="avatar"></div>
          <div class="meta">
            <div class="name" id="peer-name">Selecione uma conversa</div>
            <div class="status" id="online-badge">‚Äî</div>
          </div>
        </div>
        <div class="actions">
          <button class="icon-btn" id="chat-search">üîç</button>
          <button class="icon-btn" id="chat-info">‚ÑπÔ∏è</button>
        </div>
      </div>
      <div class="c-messages" id="messages"></div>
      <form class="c-composer" id="composer">
        <button type="button" class="icon-btn" id="attach">üìé</button>
        <input class="input" id="text" placeholder="Escreva uma mensagem‚Ä¶" autocomplete="off" />
        <button class="btn" id="send">Enviar</button>
      </form>
    </section>
  </div>

  <script>
  // Util toast
  function toast(msg,type='ok'){
    const t=document.createElement('div');
    t.className='toast '+type;
    t.textContent=msg;
    document.body.appendChild(t);
    requestAnimationFrame(()=>t.classList.add('show'));
    setTimeout(()=>{t.classList.remove('show'); setTimeout(()=>t.remove(),200)},2500);
  }

  // Mock conversas
  const chats=[
    { id:'5511999990001@s.whatsapp.net', name:'Loja Centro', last:'Pedido #123 preparado', time:'09:12' },
    { id:'5511999990002@s.whatsapp.net', name:'Cliente VIP', last:'Pode enviar a NF?', time:'Ontem' },
    { id:'5511999990003@s.whatsapp.net', name:'Fornecedor', last:'Entrega confirmada', time:'Seg' }
  ];
  let currentChat=null;
  const app=document.getElementById('app');
  const listEl=document.getElementById('chat-list');
  const messagesEl=document.getElementById('messages');
  const peerName=document.getElementById('peer-name');
  const onlineBadge=document.getElementById('online-badge');
  const backBtn=document.getElementById('back');
  const svcBadge=document.getElementById('svc-badge');
  const textInput=document.getElementById('text');
  const composer=document.getElementById('composer');
  let msgSeq=0; // contador sint√©tico para IDs de mensagens

  function renderChatList(){
    listEl.innerHTML='';
    chats.forEach(c=>{
      const item=document.createElement('div');
      item.className='chat-item';
      item.innerHTML=`<div class="avatar"></div><div class="meta"><div class="name">${c.name}</div><div class="last">${c.last}</div></div><div class="time">${c.time}</div>`;
      item.onclick=()=>selectChat(c);
      listEl.appendChild(item);
    });
  }

  function selectChat(c){
    currentChat=c;
    peerName.textContent=c.name;
    messagesEl.innerHTML='';
    // mock initial messages
    const seed=[
      {dir:'in', text:'Ol√°, em que posso ajudar?'},
      {dir:'out', text:'Quero detalhes do pedido.'},
      {dir:'in', text:'Claro! Pedido #123 sai hoje.'}
    ];
    seed.forEach(m=>pushMsg(m.dir,m.text));
    if(window.matchMedia('(max-width:1023px)').matches){
      app.dataset.view='chat';
      backBtn.style.display='inline-block';
    }
    scrollBottom();
  }

  function pushMsg(dir,text){
    const id = Date.now().toString(36)+'-'+(msgSeq++).toString(36);
    const el=document.createElement('div');
    el.className='msg '+(dir==='out'?'out':'in');
    el.setAttribute('data-id', id);
    el.textContent=text;
    // etiqueta existente (se houver)
    try {
      const tags = JSON.parse(localStorage.getItem('tags')||'{}');
      if(tags[id]){
        const tagEl=document.createElement('div');
        tagEl.className='meta';
        tagEl.textContent='#'+tags[id];
        el.appendChild(tagEl);
      }
    } catch {}
    // menu de contexto para etiquetar
    el.addEventListener('contextmenu', (e)=>{
      e.preventDefault();
      const tagInput = document.getElementById('tag-msg-id');
      if(tagInput) tagInput.value = id;
      show('#mdl-tags');
    });
    messagesEl.appendChild(el);
    scrollBottom();
  }
  function scrollBottom(){ messagesEl.scrollTop=messagesEl.scrollHeight; }

  backBtn.onclick=()=>{
    delete app.dataset.view;
    backBtn.style.display='none';
  };

  // Health status
  async function refreshHealth(){
    try{
      const r=await fetch('/health');
      if(r.ok){svcBadge.textContent='Online';svcBadge.style.background='#0f1a16';svcBadge.style.color='#9be3c2';}
      else {svcBadge.textContent='Offline';svcBadge.style.background='#3a1a1a';svcBadge.style.color='#fca5a5';}
    }catch{svcBadge.textContent='Offline';svcBadge.style.background='#3a1a1a';svcBadge.style.color='#fca5a5';}
  }
  refreshHealth(); setInterval(refreshHealth,15000);

  // Session status polling
  const storedSession=localStorage.getItem('session_id');
  async function pollSession(){
    if(!storedSession) return;
    try{
      const r=await fetch(`/sessions/${encodeURIComponent(storedSession)}/status`);
      if(r.ok){
        const j=await r.json();
        onlineBadge.textContent=j.state==='open'?'online':j.state;
      }
    }catch{}
  }
  pollSession(); setInterval(pollSession,5000);

  // Composer send
  composer.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!currentChat){ toast('Selecione uma conversa','err'); return; }
    const text=(textInput.value||'').trim();
    if(!text) return;
    pushMsg('out',text);
    const payload={ session_id: localStorage.getItem('session_id') || '', to: currentChat.id, text };
    textInput.value='';
    try{
      const r=await fetch('/messages/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(!r.ok){ toast('Falha ao enviar','err'); }
    }catch{ toast('Falha ao enviar','err'); }
  });

  // New chat just demonstrates toast
  document.getElementById('new-chat').onclick=()=>toast('Funcionalidade futura');

  renderChatList();
  // ==== Modal utilities & feature mocks ====
  function $(s,root=document){return root.querySelector(s)}
  function show(id){ $(id).classList.add('show') }
  function hide(el){ el.classList.remove('show') }
  document.querySelectorAll('.modal [data-close]')?.forEach(b=>b.addEventListener('click',e=>hide(e.target.closest('.modal'))))

  // Open modals
  $('#menu-flow')?.addEventListener('click', ()=>show('#mdl-flow'))
  $('#menu-qr')?.addEventListener('click', ()=>show('#mdl-qr'))
  $('#menu-schedule')?.addEventListener('click', ()=>show('#mdl-schedule'))
  $('#menu-tags')?.addEventListener('click', ()=>show('#mdl-tags'))

  // Conectar QR
  $('#qr-open')?.addEventListener('click', async ()=>{
    const id = $('#qr-session')?.value?.trim()
    if(!id) return toast('Informe session_id','err')
    await fetch('/sessions/create',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({session_id:id})})
    localStorage.setItem('session_id', id)
    window.open(`/qr.html?session_id=${encodeURIComponent(id)}`,'_blank')
  })

  // Fluxo do chatbot (mock)
  function loadFlows(){ try{return JSON.parse(localStorage.getItem('flows')||'[]')}catch{return []}}
  function saveFlows(f){ localStorage.setItem('flows', JSON.stringify(f)) }
  $('#flow-save')?.addEventListener('click', ()=>{
    const name = $('#flow-name')?.value?.trim()||'Fluxo'
    let json; try{ json = JSON.parse($('#flow-json')?.value || '[]') }catch(e){ return toast('JSON inv√°lido','err') }
    const flows = loadFlows(); flows.push({ id: Date.now().toString(36), name, nodes: json }); saveFlows(flows);
    toast('Fluxo salvo'); hide($('#mdl-flow'))
  })

  // Agendar envios (mock)
  function loadSchedules(){ try{return JSON.parse(localStorage.getItem('schedules')||'[]')}catch{return []}}
  function saveSchedules(x){ localStorage.setItem('schedules', JSON.stringify(x)) }
  function renderSchedules(){ const box = $('#sched-list'); if(!box) return; const arr = loadSchedules(); box.innerHTML = arr.length? arr.map(s=>`‚Ä¢ ${new Date(s.when).toLocaleString()} ‚Üí ${s.to}: "${s.text}"`).join('<br>') : 'Sem agendamentos.' }
  renderSchedules()
  $('#sched-save')?.addEventListener('click', ()=>{
    const session_id = $('#sched-session')?.value?.trim() || localStorage.getItem('session_id') || ''
    const to = $('#sched-to')?.value?.trim()
    const text = $('#sched-text')?.value?.trim()
    const when = $('#sched-when')?.value
    if(!session_id||!to||!text||!when) return toast('Preencha todos os campos','err')
    const item = { id:Date.now(), session_id, to, text, when: new Date(when).toISOString() }
    const arr = loadSchedules(); arr.push(item); saveSchedules(arr); renderSchedules(); toast('Agendado')
    const delay = new Date(item.when).getTime() - Date.now()
    if(delay > 0){ setTimeout(async ()=>{ try{ await fetch('/messages/send',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({session_id:item.session_id,to:item.to,text:item.text})}); toast('Mensagem enviada') }catch{ toast('Falha ao enviar','err') } }, delay) }
  })

  // Etiquetas (mock)
  function loadTags(){ try{return JSON.parse(localStorage.getItem('tags')||'{}')}catch{return {}}}
  function saveTags(t){ localStorage.setItem('tags', JSON.stringify(t)) }
  function renderTags(){ const box = $('#tag-list'); if(!box) return; const t = loadTags(); box.innerHTML = Object.keys(t).length? Object.entries(t).map(([k,v])=>`‚Ä¢ ${k}: ${v}`).join('<br>') : 'Sem etiquetas.' }
  renderTags()
  $('#tag-save')?.addEventListener('click', ()=>{
    const id = $('#tag-msg-id')?.value?.trim()
    const label = $('#tag-label')?.value?.trim()
    if(!id||!label) return toast('Informe id e etiqueta','err')
    const t = loadTags(); t[id]=label; saveTags(t); renderTags(); toast('Etiqueta aplicada')
  })

  // toast util fallback
  if(typeof toast!=='function'){
    window.toast = function(msg,type='ok'){
      const t=document.createElement('div');t.className='toast '+type; t.textContent=msg; document.body.appendChild(t);
      requestAnimationFrame(()=>t.classList.add('show')); setTimeout(()=>{t.classList.remove('show'); setTimeout(()=>t.remove(),200)},2500)
    }
  }
  </script>

  <!-- Fluxo do chatbot -->
  <div class="modal" id="mdl-flow">
    <div class="modal-card">
      <div class="modal-h"><strong>Fluxo do chatbot</strong><button class="m-btn" data-close>‚úï</button></div>
      <div class="modal-b">
        <p class="help">Monte um fluxo simples de n√≥s e respostas (mock). Depois plugamos no config/bot.yaml.</p>
        <div class="row"><span class="label">Nome do fluxo</span><input class="input" id="flow-name" placeholder="Ex. Recep√ß√£o Sant√™"></div>
        <div class="row"><span class="label">N√≥s</span><textarea class="input" id="flow-json" rows="8" placeholder='[{"id":"start","text":"Ol√°!","next":"menu"}]'></textarea></div>
        <div class="help">Formato JSON minimal: id, text, next (ou options:[{label,next}]).</div>
      </div>
      <div class="modal-f"><button class="m-btn" data-close>Cancelar</button><button class="btn" id="flow-save">Salvar fluxo</button></div>
    </div>
  </div>

  <!-- Conectar QR -->
  <div class="modal" id="mdl-qr">
    <div class="modal-card">
      <div class="modal-h"><strong>Conectar QR</strong><button class="m-btn" data-close>‚úï</button></div>
      <div class="modal-b">
        <div class="row"><span class="label">Session ID</span><input class="input" id="qr-session" placeholder="Ex. santemoda-01"></div>
        <p class="help">Cria a sess√£o e abre o QR em nova aba.</p>
      </div>
      <div class="modal-f"><button class="m-btn" data-close>Fechar</button><button class="btn" id="qr-open">Abrir QR</button></div>
    </div>
  </div>

  <!-- Agendar envios -->
  <div class="modal" id="mdl-schedule">
    <div class="modal-card">
      <div class="modal-h"><strong>Agendar envios</strong><button class="m-btn" data-close>‚úï</button></div>
      <div class="modal-b">
        <div class="row"><span class="label">Session ID</span><input class="input" id="sched-session" placeholder="Ex. santemoda-01"></div>
        <div class="row"><span class="label">Para (JID)</span><input class="input" id="sched-to" placeholder="5511999999999@s.whatsapp.net"></div>
        <div class="row"><span class="label">Mensagem</span><input class="input" id="sched-text" placeholder="Texto da campanha"></div>
        <div class="row"><span class="label">Quando</span><input class="input" id="sched-when" type="datetime-local"></div>
        <div class="help">Mock local: salva no localStorage e executa no hor√°rio via setTimeout (enquanto a p√°gina estiver aberta).</div>
        <div id="sched-list" class="help"></div>
      </div>
      <div class="modal-f"><button class="m-btn" data-close>Fechar</button><button class="btn" id="sched-save">Agendar</button></div>
    </div>
  </div>

  <!-- Etiquetar mensagem -->
  <div class="modal" id="mdl-tags">
    <div class="modal-card">
      <div class="modal-h"><strong>Etiquetar mensagem</strong><button class="m-btn" data-close>‚úï</button></div>
      <div class="modal-b">
        <div class="row"><span class="label">ID da msg</span><input class="input" id="tag-msg-id" placeholder="ex. key.id"></div>
        <div class="row"><span class="label">Etiqueta</span><input class="input" id="tag-label" placeholder="Prioridade, VIP, Suporte..."></div>
        <div class="help">Mock: vamos manter um map de etiquetas em localStorage (msgId -> tag).</div>
        <div id="tag-list" class="help"></div>
      </div>
      <div class="modal-f"><button class="m-btn" data-close>Fechar</button><button class="btn" id="tag-save">Aplicar etiqueta</button></div>
    </div>
  </div>
</body>
</html>