<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#128C7E" />
  <title>ZapSan</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/mobile-enhancements.css" />
  <link rel="stylesheet" href="/mobile-fixes.css" />
  <script>(function(){
    try {
      const onLogin = location.pathname.endsWith('/login.html');
      const hasFlag = localStorage.getItem('auth')==='ok';
      // Hidratar session_id a partir da URL, se presente (deep-link/share)
      try {
        const u = new URL(window.location.href);
        const sidQ = u.searchParams.get('session_id');
        if(sidQ){
          localStorage.setItem('session_id', sidQ);
          if(!localStorage.getItem('sessionId')) localStorage.setItem('sessionId', sidQ);
        }
      } catch {}
      // Se j√° temos session_id no storage e n√£o est√° na URL, refletir imediatamente
      try {
        const sid = localStorage.getItem('session_id') || localStorage.getItem('sessionId');
        if(sid){
          const u = new URL(window.location.href);
          if(u.searchParams.get('session_id') !== sid){
            u.searchParams.set('session_id', sid);
            history.replaceState(null, '', u.toString());
          }
        }
      } catch {}
      // Shim: garantir chave legacy session_id usando sessionId se existir
      try { const sid = localStorage.getItem('sessionId'); if(sid && !localStorage.getItem('session_id')) localStorage.setItem('session_id', sid); } catch {}
      if(onLogin && hasFlag){ location.replace('/'); return; }
      if(!hasFlag){
        // tentativa silenciosa de validar cookie/sess√£o; se falhar, for√ßa login
        fetch('/me/profile',{method:'GET'}).then(r=>{
          if(r.status===401){ if(!onLogin) location.replace('/login.html'); }
          else if(r.ok){ if(onLogin) location.replace('/'); else localStorage.setItem('auth','ok'); }
          else { if(!onLogin) location.replace('/login.html'); }
        }).catch(()=>{ if(!onLogin) location.replace('/login.html'); });
      }
    } catch {}
  })();</script>
</head>
<body>
  <header class="topbar"><div class="topbar-inner">
    <div class="top-left">
      <div class="dropdown dropdown-left" id="hamb-menu">
        <button type="button" class="icon-btn icon-menu" id="hamb-btn" aria-label="Menu" aria-expanded="false"></button>
        <div class="dropdown-menu" role="menu" id="hamb-content">
          <button type="button" class="menu-item" id="menu-flow" role="menuitem">Fluxo IA</button>
          <button type="button" class="menu-item" id="menu-schedule" role="menuitem">Agendar envios</button>
          <button type="button" class="menu-item" id="menu-tags" role="menuitem">Etiquetas</button>
        </div>
      </div>
    </div>
    <div class="brand icon-whatsapp">ZapSan</div>
    <div class="top-right">
      <button type="button" class="icon-btn" id="theme-toggle" aria-label="Alternar tema" title="Tema"></button>
      <div class="badge icon-status" id="svc-badge">Carregando‚Ä¶</div>
      <button type="button" class="m-btn icon-user" id="profile-btn" aria-haspopup="dialog" title="Perfil"></button>
    </div>
  </div></header>

  <div class="app" id="app">
    <aside class="sidebar">
      <div class="s-header">
        <div class="brand" style="font-size:15px">Conversas</div>
  <div class="actions"><button type="button" class="icon-btn icon-user" id="new-chat" aria-label="Nova conversa">
    <span class="btn-text">+</span>
  </button></div>
      </div>
      <div class="s-search"><input class="input" id="search" placeholder="Pesquisar conversas‚Ä¶"></div>
      <div class="s-filters">
        <button class="chip is-active" data-filter="all">Todos</button>
        <button class="chip" data-filter="unread">N√£o lidas</button>
        <button class="chip" data-filter="starred">Com estrela</button>
      </div>
      <div class="chat-list" id="chat-list"></div>
    </aside>

    <section class="chat">
      <div class="c-header">
        <div class="peer">
          <button type="button" class="icon-btn" id="back" style="display:none" aria-label="Voltar">‚Üê</button>
          <div class="avatar"></div>
          <div class="meta">
            <div class="name" id="peer-name">Selecione uma conversa</div>
            <div class="status" id="online-badge">‚Äî</div>
          </div>
        </div>
        <div class="actions">
          <button type="button" class="icon-btn" id="chat-search" aria-label="Buscar na conversa">üîç</button>
          <button type="button" class="icon-btn" id="chat-info" aria-label="Informa√ß√µes da conversa">‚ÑπÔ∏è</button>
        </div>
      </div>
      <div class="c-messages" id="messages"></div>
    <form class="c-composer" id="composer">
  <button type="button" class="icon-btn" id="attach" aria-label="Anexar arquivo">üìé</button>
  <div class="input-wrapper">
    <textarea class="input" id="text" placeholder="Escreva uma mensagem‚Ä¶" aria-label="Mensagem" rows="1" style="resize:none;overflow:hidden"></textarea>
    <div class="composer-actions">
      <button type="button" class="icon-btn" id="emoji" aria-label="Emoji" title="Emoji">üòä</button>
      <button type="submit" class="send-btn" id="send" aria-label="Enviar mensagem" title="Enviar">
        <span>‚û§</span>
      </button>
    </div>
  </div>
    </form>
    </section>
  </div>

  <!-- Bottom Navigation for Mobile -->
  <nav class="bottom-nav" id="bottom-nav">
    <a href="#" class="bottom-nav-item active" data-nav="chats">
      <span class="icon">üí¨</span>
      <span>Chats</span>
    </a>
    <a href="#" class="bottom-nav-item" data-nav="status">
      <span class="icon">üì∏</span>
      <span>Status</span>
    </a>
    <a href="#" class="bottom-nav-item" data-nav="schedule">
      <span class="icon">‚è∞</span>
      <span>Agendar</span>
    </a>
    <a href="#" class="bottom-nav-item" data-nav="contacts">
      <span class="icon">üìû</span>
      <span>Contatos</span>
    </a>
  </nav>

  <!-- Drawer Perfil -->
  <div class="drawer" id="drw-profile">
    <div class="drawer-panel" role="dialog" aria-modal="true" aria-labelledby="profile-title">
      <div class="drawer-h">
        <h3 id="profile-title" style="margin:0">Perfil</h3>
        <button class="icon-btn" data-close-profile aria-label="Fechar">‚úñ</button>
      </div>
      <div class="drawer-b" id="profile-body">
        <div class="section">
          <strong>Usu√°rio:</strong> <span id="pf-user">‚Äî</span><br/>
          <strong>Session ID:</strong> <span id="pf-session">‚Äî</span>
        </div>
        <div class="section">
          <strong>Plano:</strong> <span id="pf-plan">‚Äî</span><br/>
          <small>Uso di√°rio: <span id="pf-usage-today">0</span>/<span id="pf-quota">0</span></small><br/>
          <small>Total: <span id="pf-usage-total">0</span></small>
        </div>
        <div class="section">
          <strong>Conex√£o</strong>
          <div class="row" style="margin-top:6px"><span class="label" style="width:auto;min-width:80px">Status:</span> <span id="pf-conn">‚Äî</span> <small class="help" style="margin-left:8px">(<span id="pf-state">‚Äî</span>)</small></div>
          <div class="help" id="pf-jid" style="margin-top:4px;">‚Äî</div>
          <div id="pf-qr-wrap" style="margin-top:6px;display:none"><img id="pf-qr" alt="QR" style="max-width:180px;border:1px solid #222;padding:4px;border-radius:4px"/></div>
          <div class="row" style="gap:6px;margin-top:8px">
            <button class="btn sm" id="btn-connect">Conectar</button>
            <button class="btn sm outline" id="btn-generate-qr">Gerar QRCode</button>
            <button class="btn sm outline" id="btn-disconnect" style="display:none">Desconectar</button>
            <button class="btn sm" id="btn-regen-qr" style="display:none">Regenerar QR</button>
            <button class="btn sm" id="btn-clean" style="display:none">Desvincular</button>
          </div>
        </div>
      </div>
      <div class="drawer-f" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
        <button class="btn outline" id="btn-logout">Logout</button>
        <button class="btn" data-close-profile>Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal Nova Conversa -->
  <div class="modal" id="new-chat-modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-h">
        <h3>Nova Conversa</h3>
        <button type="button" class="close-btn" data-close-new-chat aria-label="Fechar">√ó</button>
      </div>
      <div class="modal-body">
        <form id="new-chat-form">
          <div class="field">
            <label for="phone-input">N√∫mero do telefone:</label>
            <input type="text" id="phone-input" class="input" placeholder="+55 98 99999-9999" maxlength="20">
            <div class="validation-feedback" id="phone-validation" style="margin-top: 8px; font-size: 14px; display: none;"></div>
            <div class="help">Digite o n√∫mero completo. Para celulares, incluir o 9¬∫ d√≠gito</div>
          </div>
        </form>
      </div>
      <div class="modal-f">
        <button type="button" class="btn outline" data-close-new-chat>Cancelar</button>
        <button type="submit" form="new-chat-form" class="btn" id="create-chat-btn">Iniciar Conversa</button>
      </div>
    </div>
  </div>

  <!-- Modal Confirmar Exclus√£o -->
  <div class="modal" id="delete-contact-modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-h">
        <h3>Excluir Conversa</h3>
        <button type="button" class="close-btn" data-close-delete aria-label="Fechar">√ó</button>
      </div>
      <div class="modal-body">
        <p>Tem certeza que deseja excluir a conversa com <strong id="delete-contact-name">este contato</strong>?</p>
        <p class="help">Esta a√ß√£o n√£o pode ser desfeita.</p>
      </div>
      <div class="modal-f">
        <button type="button" class="btn outline" data-close-delete>Cancelar</button>
        <button type="button" class="btn danger" id="confirm-delete-btn">Excluir</button>
      </div>
    </div>
  </div>

  <!-- Modal Gerenciar Contatos -->
  <div class="modal" id="contacts-modal" aria-hidden="true">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-h">
        <h3 style="margin: 0;">üìû Gerenciar Contatos</h3>
        <button class="close-btn" data-close-contacts aria-label="Fechar">√ó</button>
      </div>
      <div class="modal-body">
        <!-- Barra de Ferramentas -->
        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
          <input type="text" id="contact-search" placeholder="üîç Buscar contatos..." class="input" style="flex: 1; min-width: 200px;">
          <button type="button" class="btn" id="add-contact-btn">‚ûï Adicionar</button>
          <button type="button" class="btn outline" id="import-contacts-btn">üì• Importar</button>
          <button type="button" class="btn outline" id="export-contacts-btn">üì§ Exportar</button>
        </div>

        <!-- Estat√≠sticas -->
        <div id="contact-stats" style="display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap;">
          <div class="badge">Total: <span id="stats-total">0</span></div>
          <div class="badge">Com notas: <span id="stats-notes">0</span></div>
          <div class="badge">Tags: <span id="stats-tags">0</span></div>
        </div>

        <!-- Lista de Contatos -->
        <div id="contacts-list" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--wa-border); border-radius: 12px;">
          <div id="contacts-empty" style="text-align: center; padding: 40px; color: var(--muted);">
            <p>üì± Nenhum contato encontrado</p>
            <p style="font-size: 0.9rem;">Adicione contatos manualmente ou importe de uma planilha</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Adicionar/Editar Contato -->
  <div class="modal" id="contact-form-modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-h">
        <h3 id="contact-form-title" style="margin: 0;">Adicionar Contato</h3>
        <button class="close-btn" data-close-contact-form aria-label="Fechar">√ó</button>
      </div>
      <div class="modal-body">
        <form id="contact-form">
          <div class="field">
            <label for="contact-name">Nome *</label>
            <input type="text" id="contact-name" class="input" placeholder="Nome do contato" required>
          </div>
          <div class="field">
            <label for="contact-phone">Telefone *</label>
            <input type="tel" id="contact-phone" class="input" placeholder="5598999999999" required>
            <div class="help">Formato: c√≥digo do pa√≠s + DDD + n√∫mero (ex: 5598999999999)</div>
          </div>
          <div class="field">
            <label for="contact-tags">Tags</label>
            <input type="text" id="contact-tags" class="input" placeholder="cliente, importante, fam√≠lia">
            <div class="help">Separe as tags por v√≠rgula</div>
          </div>
          <div class="field">
            <label for="contact-notes">Notas</label>
            <textarea id="contact-notes" class="input" placeholder="Observa√ß√µes sobre o contato..." rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-f">
        <button type="button" class="btn outline" data-close-contact-form>Cancelar</button>
        <button type="button" class="btn" id="save-contact-btn">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Input oculto para importa√ß√£o -->
  <input type="file" id="import-file-input" accept=".csv,.xlsx,.xls" style="display: none;">

  <script src="/contacts.js"></script>
  <script>
  // Util toast
  function toast(msg,type='ok'){
    const t=document.createElement('div');
    t.className='toast '+type;
    t.textContent=msg;
    document.body.appendChild(t);
    requestAnimationFrame(()=>t.classList.add('show'));
    setTimeout(()=>{t.classList.remove('show'); setTimeout(()=>t.remove(),200)},2500);
  }

  // Estado din√¢mico: chats (Map) e mensagens por JID
  const chatsMap = new Map(); // jid -> { id, name, last, time, unread, starred }
  const messagesByJid = new Map(); // jid -> [ { id,text,fromMe,timestamp } ]
  const contactsMap = new Map(); // jid -> { name, is_group }
  let activeFilter='all';
  let currentChat=null; // objeto { id, name }
  const app=document.getElementById('app');
  const listEl=document.getElementById('chat-list');
  const messagesEl=document.getElementById('messages');
  const peerName=document.getElementById('peer-name');
  const onlineBadge=document.getElementById('online-badge');
  const backBtn=document.getElementById('back');
  const svcBadge=document.getElementById('svc-badge');
  const textInput=document.getElementById('text');
  const composer=document.getElementById('composer');
  let msgSeq=0; // contador sint√©tico para IDs de mensagens
  const LS_CHAT_KEY='last_chat_id';

  // Buscar contatos salvos do backend
  async function loadContacts() {
    try {
      const response = await fetch('/me/contacts');
      if (response.ok) {
        const data = await response.json();
        contactsMap.clear();
        data.contacts.forEach(contact => {
          contactsMap.set(contact.jid, {
            name: contact.name,
            is_group: contact.is_group
          });
        });
        console.log('Contatos carregados:', contactsMap.size);
      }
    } catch (err) {
      console.warn('Erro ao carregar contatos:', err);
    }
  }

  // Fun√ß√£o para formatar JID em nome leg√≠vel
  function formatContactName(jid) {
    if (!jid) return 'Desconhecido';
    
    // Extrair n√∫mero do JID
    const phone = jid.includes('@') ? jid.split('@')[0] : jid;
    
    // üÜï USAR SISTEMA DE CONTATOS
    const contactName = contactManager.getContactName(phone);
    
    // Se encontrou nome no sistema, retorna
    if (contactName && contactName !== phone) {
      return contactName;
    }
    
    // Fallback: verificar contactsMap antigo (compatibilidade)
    const oldContact = contactsMap.get(jid);
    if (oldContact && oldContact.name && oldContact.name !== jid) {
      return oldContact.name;
    }
    
    // Fallback: formatar n√∫mero bonito
    if (phone.startsWith('55') && phone.length >= 12) {
      const ddd = phone.substring(2, 4);
      const number = phone.substring(4);
      const part1 = number.substring(0, number.length - 4);
      const part2 = number.substring(number.length - 4);
      return `+55 (${ddd}) ${part1}-${part2}`;
    }
    
    return `+${phone}`;
  }

  // Cache de fotos de perfil
  const profilePhotosCache = new Map();

  // Fun√ß√£o para buscar foto de perfil
  async function getProfilePhoto(jid, type = 'preview') {
    const cacheKey = `${jid}_${type}`;
    
    // Verificar cache primeiro
    if (profilePhotosCache.has(cacheKey)) {
      return profilePhotosCache.get(cacheKey);
    }
    
    try {
      const response = await fetch(`/contacts/${encodeURIComponent(jid)}/photo?type=${type}`);
      if (response.ok) {
        const data = await response.json();
        const photoUrl = data.success ? data.profileUrl : null;
        
        // Guardar no cache (null tamb√©m √© v√°lido)
        profilePhotosCache.set(cacheKey, photoUrl);
        
        return photoUrl;
      }
    } catch (error) {
      console.warn('Erro ao buscar foto de perfil:', error);
    }
    
    // Em caso de erro, cachear null
    profilePhotosCache.set(cacheKey, null);
    return null;
  }

  // Fun√ß√£o para criar avatar com foto ou iniciais
  async function createAvatarElement(jid) {
    const avatarEl = document.createElement('div');
    avatarEl.className = 'avatar';
    
    try {
      const photoUrl = await getProfilePhoto(jid, 'preview');
      
      if (photoUrl) {
        // Usar foto de perfil
        avatarEl.style.backgroundImage = `url("${photoUrl}")`;
        avatarEl.style.backgroundSize = 'cover';
        avatarEl.style.backgroundPosition = 'center';
        avatarEl.innerHTML = ''; // Limpar conte√∫do
      } else {
        // Usar iniciais
        const displayName = formatContactName(jid);
        const initials = displayName.split(' ')
          .map(word => word.charAt(0).toUpperCase())
          .join('')
          .substring(0, 2);
        
        avatarEl.textContent = initials;
        avatarEl.style.backgroundImage = 'none';
      }
    } catch (error) {
      // Em caso de erro, usar iniciais
      const displayName = formatContactName(jid);
      const initials = displayName.split(' ')
        .map(word => word.charAt(0).toUpperCase())
        .join('')
        .substring(0, 2);
      
      avatarEl.textContent = initials;
      avatarEl.style.backgroundImage = 'none';
    }
    
    return avatarEl;
  }

  // Fun√ß√£o para normalizar n√∫meros brasileiros
  function normalizeBrazilianPhone(phone) {
    // Remove todos os caracteres n√£o num√©ricos
    const digits = phone.replace(/\D/g, '');
    
    // Se j√° tem @ √© um JID, retorna como est√°
    if (phone.includes('@')) return phone;
    
    // Se n√£o come√ßa com 55, assume Brasil e adiciona
    let workingDigits = digits;
    if (!workingDigits.startsWith('55')) {
      workingDigits = '55' + digits;
    }
    
    // Remove c√≥digo do pa√≠s (55)
    const withoutCountry = workingDigits.slice(2);
    
    // Se tem menos de 10 d√≠gitos, n√∫mero inv√°lido
    if (withoutCountry.length < 10) {
      return null; // N√∫mero inv√°lido
    }
    
    // Extrai DDD e resto do n√∫mero
    const ddd = withoutCountry.slice(0, 2);
    const rest = withoutCountry.slice(2);
    
    // Valida DDD (11-99)
    const dddNum = parseInt(ddd);
    if (dddNum < 11 || dddNum > 99) {
      return null; // DDD inv√°lido
    }
    
    // Se tem 8 d√≠gitos, √© telefone fixo
    if (rest.length === 8) {
      return `55${ddd}${rest}`;
    }
    
    // Se tem 9 d√≠gitos mas n√£o come√ßa com 9, adiciona 9
    if (rest.length === 8) {
      return `55${ddd}9${rest}`;
    }
    
    // Se tem 9 d√≠gitos e j√° come√ßa com 9, mant√©m
    if (rest.length === 9 && rest.startsWith('9')) {
      return workingDigits;
    }
    
    // Se tem 9 d√≠gitos mas n√£o come√ßa com 9, adiciona 9
    if (rest.length === 9 && !rest.startsWith('9')) {
      return `55${ddd}9${rest}`;
    }
    
    return workingDigits;
  }

  // Fun√ß√£o para formatar n√∫mero para exibi√ß√£o
  function formatPhoneDisplay(phone) {
    const digits = phone.replace(/\D/g, '');
    
    if (digits.startsWith('55') && digits.length >= 12) {
      const ddd = digits.slice(2, 4);
      const first = digits.slice(4, 9);
      const second = digits.slice(9);
      return `+55 ${ddd} ${first}-${second}`;
    }
    
    return phone;
  }

  // Fun√ß√£o para validar formato brasileiro obrigat√≥rio: 55 + DDD + 9 + 8 d√≠gitos
  function validateBrazilianPhone(phone) {
    // Remove todos os caracteres n√£o num√©ricos
    const digits = phone.replace(/\D/g, '');
    
    // Deve ter exatamente 13 d√≠gitos (55 + 2 DDD + 1 nono d√≠gito + 8 n√∫meros)
    if (digits.length !== 13) {
      return {
        valid: false,
        message: 'N√∫mero deve ter 13 d√≠gitos: 55 + DDD + 9 + 8 n√∫meros',
        normalized: null
      };
    }
    
    // Deve come√ßar com 55 (c√≥digo do Brasil)
    if (!digits.startsWith('55')) {
      return {
        valid: false,
        message: 'N√∫mero deve come√ßar com 55 (c√≥digo do Brasil)',
        normalized: null
      };
    }
    
    // Extrai DDD (d√≠gitos 3 e 4)
    const ddd = digits.slice(2, 4);
    const dddNumber = parseInt(ddd);
    
    // Verifica se √© um DDD v√°lido (11-99)
    if (dddNumber < 11 || dddNumber > 99) {
      return {
        valid: false,
        message: 'DDD inv√°lido. Deve estar entre 11 e 99',
        normalized: null
      };
    }
    
    // Verifica se o 5¬∫ d√≠gito √© 9 (nono d√≠gito obrigat√≥rio para celulares)
    const ninthDigit = digits[4];
    if (ninthDigit !== '9') {
      return {
        valid: false,
        message: 'N√∫mero de celular deve ter o 9¬∫ d√≠gito. Formato: 55 + DDD + 9 + 8 n√∫meros',
        normalized: null
      };
    }
    
    return {
      valid: true,
      message: 'N√∫mero v√°lido',
      normalized: digits,
      formatted: formatPhoneDisplay(digits)
    };
  }

  async function renderChatList(){
    listEl.innerHTML='';
    const lastId = localStorage.getItem(LS_CHAT_KEY);
    const chatsArr = Array.from(chatsMap.values()).sort((a,b)=> (b.timestamp||0)-(a.timestamp||0));
    
    const filteredChats = chatsArr.filter(c=>{
      if(activeFilter==='unread') return (c.unread||0) > 0;
      if(activeFilter==='starred') return !!c.starred;
      return true;
    });

    // Renderizar chats um por vez para carregar fotos
    for (const c of filteredChats) {
      const item = document.createElement('div');
      item.className='chat-item';
      item.dataset.chatId = c.id; // Para identifica√ß√£o nos gestos
      if(currentChat && currentChat.id===c.id) item.classList.add('is-active');
      if(!currentChat && lastId && lastId===c.id) item.classList.add('is-active');
      
      const unreadBadge = (c.unread||0) > 0 ? `<span class="unread">${c.unread}</span>` : '';
      const star = `<button class="star-btn" data-star="${c.id}" aria-label="Marcar favorito">${c.starred?'‚òÖ':'‚òÜ'}</button>`;
      const deleteBtn = `<button class="delete-btn" data-delete="${c.id}" aria-label="Excluir conversa" title="Excluir conversa">üóëÔ∏è</button>`;
      const displayName = formatContactName(c.id);
      
      // Criar avatar com foto
      const avatarEl = await createAvatarElement(c.id);
      
      // Swipe actions para mobile
      const swipeActions = `
        <div class="swipe-actions">
          <button class="swipe-action star" data-action="star" data-chat="${c.id}">‚≠ê</button>
          <button class="swipe-action delete" data-action="delete" data-chat="${c.id}">üóëÔ∏è</button>
        </div>
      `;
      
      item.innerHTML = `${swipeActions}<div class="meta"><div class="name">${displayName} <div class="actions">${star}${deleteBtn}</div></div><div class="last">${escapeHtml(c.last||'')}</div></div><div class="time">${c.time||''} ${unreadBadge}</div>`;
      
      // Inserir avatar no in√≠cio
      item.insertBefore(avatarEl, item.firstChild);
      
      item.addEventListener('click',(ev)=>{
        const target = ev.target;
        if(target && target.closest && (target.closest('.star-btn') || target.closest('.delete-btn'))) return;
        selectChat(c.id);
      });
      
      listEl.appendChild(item);
    }
    
    // estrela toggle
    listEl.querySelectorAll('.star-btn').forEach(btn=>{
      btn.addEventListener('click', function(e){
        e.stopPropagation();
        const id=this.getAttribute('data-star');
        const chat=chatsMap.get(id);
        if(chat){ chat.starred=!chat.starred; renderChatList(); }
      })
    })
    // delete toggle
    listEl.querySelectorAll('.delete-btn').forEach(btn=>{
      btn.addEventListener('click', function(e){
        e.stopPropagation();
        const jid = this.getAttribute('data-delete');
        openDeleteModal(jid);
      })
    })
  }

  // Vari√°vel para guardar JID a ser deletado
  let contactToDelete = null;

  // Abrir modal de confirma√ß√£o de exclus√£o
  function openDeleteModal(jid) {
    contactToDelete = jid;
    const displayName = formatContactName(jid);
    document.getElementById('delete-contact-name').textContent = displayName;
    document.getElementById('delete-contact-modal').setAttribute('aria-hidden', 'false');
  }

  // Fechar modal de exclus√£o
  document.querySelectorAll('[data-close-delete]').forEach(btn => {
    btn.onclick = () => {
      document.getElementById('delete-contact-modal').setAttribute('aria-hidden', 'true');
      contactToDelete = null;
    };
  });

  // Confirmar exclus√£o
  document.getElementById('confirm-delete-btn').onclick = async () => {
    if (!contactToDelete) return;
    
    try {
      const response = await fetch(`/me/contacts/${encodeURIComponent(contactToDelete)}`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        // Remover do frontend
        chatsMap.delete(contactToDelete);
        messagesByJid.delete(contactToDelete);
        contactsMap.delete(contactToDelete);
        
        // Se era o chat ativo, limpar sele√ß√£o
        if (currentChat && currentChat.id === contactToDelete) {
          currentChat = null;
          peerName.textContent = 'Selecione uma conversa';
          messagesEl.innerHTML = '';
          if (window.matchMedia('(max-width:1023px)').matches) {
            delete app.dataset.view;
            backBtn.style.display = 'none';
          }
        }
        
        renderChatList();
        toast('Conversa exclu√≠da com sucesso');
      } else {
        throw new Error('Erro ao excluir');
      }
    } catch (err) {
      console.error('Erro ao excluir contato:', err);
      toast('Erro ao excluir conversa', 'err');
    }
    
    // Fechar modal
    document.getElementById('delete-contact-modal').setAttribute('aria-hidden', 'true');
    contactToDelete = null;
  };

  function escapeHtml(t){ return t.replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]||c)) }

  // === LINKIFY FUNCTION ===
  function linkify(text) {
    // Regex para detectar URLs (http, https, www, e dom√≠nios simples)
    const urlRegex = /(https?:\/\/[^\s<>"']+|www\.[^\s<>"']+|[a-zA-Z0-9][a-zA-Z0-9-]*\.[a-zA-Z]{2,}(?:\/[^\s<>"']*)?)/gi;
    
    return text.replace(urlRegex, (url) => {
      let href = url;
      // Adicionar protocolo se necess√°rio
      if (!url.match(/^https?:\/\//)) {
        href = 'https://' + url;
      }
      
      return `<a href="${href}" target="_blank" rel="noopener noreferrer" class="msg-link">${url}</a>`;
    });
  }

  async function selectChat(jid){
    const chat = chatsMap.get(jid);
    if(!chat) return;
    currentChat = chat;
    localStorage.setItem(LS_CHAT_KEY, chat.id);
    chat.unread = 0;
    peerName.textContent = formatContactName(jid);
    
    // Atualizar avatar do cabe√ßalho
    const headerAvatar = document.querySelector('.c-header .avatar');
    if (headerAvatar) {
      const newAvatar = await createAvatarElement(jid);
      headerAvatar.replaceWith(newAvatar);
    }
    
    messagesEl.innerHTML='';
    const msgs = messagesByJid.get(jid)||[];
    msgs.sort((a,b)=>a.timestamp-b.timestamp).forEach(m=>pushMsg(m.fromMe?'out':'in', m.text, m.id, m.mediaInfo));
    if(window.matchMedia('(max-width:1023px)').matches){ app.dataset.view='chat'; backBtn.style.display='inline-block'; }
    document.querySelectorAll('.chat-item').forEach(el=>el.classList.remove('is-active'));
    const displayName = formatContactName(jid);
    requestAnimationFrame(()=>{
      [...document.querySelectorAll('.chat-item')].find(el=>el.textContent.includes(displayName))?.classList.add('is-active');
    })
    scrollBottom();
    renderChatList(); // atualiza contadores
  }

  function pushMsg(dir,text,id,mediaInfo){
    const temp = !id;
    id = id || (Date.now().toString(36)+'-'+(msgSeq++).toString(36));
    const el=document.createElement('div');
    el.className='msg '+(dir==='out'?'out':'in');
    el.setAttribute('data-id', id);
    
    // Verificar se tem m√≠dia
    if(mediaInfo && mediaInfo.type !== 'document') {
      // Criar preview de m√≠dia
      const mediaEl = createMediaPreview(mediaInfo, id);
      el.appendChild(mediaEl);
      
      // Adicionar caption se houver texto
      if(text && text !== `üìé ${mediaInfo.filename}`) {
        const captionEl = document.createElement('div');
        captionEl.className = 'media-caption';
        captionEl.innerHTML = linkify(escapeHtml(text));
        el.appendChild(captionEl);
      }
    } else {
      // Mensagem de texto normal ou documento
      const linkedText = linkify(escapeHtml(text));
      el.innerHTML = linkedText;
    }
    
    if(temp) el.classList.add('pending');
    // etiqueta existente via API (fetch pregui√ßoso)
    fetch('/tags').then(r=>r.ok?r.json():{tags:{}}).then(j=>{
      const t=j.tags||{}; if(t[id]){ const tagEl=document.createElement('div'); tagEl.className='meta'; tagEl.textContent='#'+t[id]; el.appendChild(tagEl); }
    }).catch(()=>{})
    // menu de contexto para etiquetar
    el.addEventListener('contextmenu', (e)=>{
      e.preventDefault();
      const tagInput = document.getElementById('tag-msg-id');
      if(tagInput) tagInput.value = id;
      show('#mdl-tags');
    });
    messagesEl.appendChild(el);
    scrollBottom();
  }
  
  // Fun√ß√£o para criar preview de m√≠dia
  function createMediaPreview(mediaInfo, messageId) {
    const container = document.createElement('div');
    container.className = `media-preview media-${mediaInfo.type}`;
    
    if(mediaInfo.type === 'image') {
      const img = document.createElement('img');
      img.className = 'media-thumbnail lazy';
      img.src = '/media/thumbnail/' + getMediaHash(mediaInfo);
      img.alt = mediaInfo.filename;
      img.style.cssText = 'max-width: 250px; max-height: 200px; border-radius: 8px; cursor: pointer;';
      
      // Click para abrir modal de preview
      img.onclick = () => openMediaModal(mediaInfo, messageId);
      
      container.appendChild(img);
    } else if(mediaInfo.type === 'video') {
      const videoContainer = document.createElement('div');
      videoContainer.className = 'video-preview';
      videoContainer.style.cssText = 'position: relative; max-width: 250px; max-height: 200px; border-radius: 8px; cursor: pointer; background: #000;';
      
      const thumbnail = document.createElement('img');
      thumbnail.src = '/media/thumbnail/' + getMediaHash(mediaInfo);
      thumbnail.style.cssText = 'width: 100%; height: 100%; object-fit: cover; border-radius: 8px;';
      
      const playBtn = document.createElement('div');
      playBtn.innerHTML = '‚ñ∂Ô∏è';
      playBtn.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; color: white; background: rgba(0,0,0,0.7); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center;';
      
      videoContainer.appendChild(thumbnail);
      videoContainer.appendChild(playBtn);
      videoContainer.onclick = () => openMediaModal(mediaInfo, messageId);
      
      container.appendChild(videoContainer);
    } else if(mediaInfo.type === 'audio') {
      const audioEl = document.createElement('div');
      audioEl.className = 'audio-preview';
      audioEl.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; max-width: 250px;';
      
      const iconEl = document.createElement('div');
      iconEl.innerHTML = 'üéµ';
      iconEl.style.fontSize = '24px';
      
      const infoEl = document.createElement('div');
      infoEl.innerHTML = `<div style="font-weight: 500;">${mediaInfo.filename}</div><div style="font-size: 0.8em; opacity: 0.7;">${formatFileSize(mediaInfo.size)}</div>`;
      
      audioEl.appendChild(iconEl);
      audioEl.appendChild(infoEl);
      audioEl.onclick = () => openMediaModal(mediaInfo, messageId);
      
      container.appendChild(audioEl);
    }
    
    return container;
  }
  
  // Modal para visualiza√ß√£o de m√≠dia
  function openMediaModal(mediaInfo, messageId) {
    const modal = document.createElement('div');
    modal.className = 'media-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';
    
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '‚úñ';
    closeBtn.style.cssText = 'position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;';
    closeBtn.onclick = () => modal.remove();
    
    let content;
    if(mediaInfo.type === 'image') {
      content = document.createElement('img');
      content.src = '/media/preview/' + getMediaHash(mediaInfo);
      content.style.cssText = 'max-width: 90vw; max-height: 90vh; object-fit: contain;';
    } else if(mediaInfo.type === 'video') {
      content = document.createElement('video');
      content.src = `/media/original/${currentChat?.sessionId || 'default'}/${messageId}`;
      content.controls = true;
      content.style.cssText = 'max-width: 90vw; max-height: 90vh;';
    } else if(mediaInfo.type === 'audio') {
      content = document.createElement('div');
      content.style.cssText = 'text-align: center; color: white;';
      
      const audioEl = document.createElement('audio');
      audioEl.src = `/media/original/${currentChat?.sessionId || 'default'}/${messageId}`;
      audioEl.controls = true;
      audioEl.style.width = '300px';
      
      const infoEl = document.createElement('div');
      infoEl.innerHTML = `<h3>${mediaInfo.filename}</h3><p>${formatFileSize(mediaInfo.size)}</p>`;
      
      content.appendChild(infoEl);
      content.appendChild(audioEl);
    }
    
    modal.appendChild(closeBtn);
    modal.appendChild(content);
    document.body.appendChild(modal);
    
    // Fechar com ESC ou clique fora
    modal.addEventListener('click', (e) => {
      if(e.target === modal) modal.remove();
    });
    document.addEventListener('keydown', function escHandler(e) {
      if(e.key === 'Escape') {
        modal.remove();
        document.removeEventListener('keydown', escHandler);
      }
    });
  }
  
  // Utilit√°rios
  function getMediaHash(mediaInfo) {
    // Gerar hash baseado no filename e size para identificar m√≠dia
    if(!mediaInfo || !mediaInfo.filename) return 'unknown';
    const hashInput = mediaInfo.filename + (mediaInfo.size || 0);
    return hashInput.replace(/[^a-zA-Z0-9]/g, '').substring(0, 16) + '.webp';
  }
  
  function formatFileSize(bytes) {
    if(bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
  function scrollBottom(){ messagesEl.scrollTop=messagesEl.scrollHeight; }

  backBtn.onclick=()=>{
    delete app.dataset.view;
    backBtn.style.display='none';
  };

  // Service badge reflects WhatsApp session health (ONLINE only when state==='open')
  function setSvcBadge(online){
    if(!svcBadge) return;
    svcBadge.textContent = online ? 'ONLINE' : 'OFFLINE';
    svcBadge.style.background = online ? '#0f1a16' : '#3a1a1a';
    svcBadge.style.color = online ? '#9be3c2' : '#fca5a5';
  }
  // default state until first poll
  setSvcBadge(false);

  // Session status polling
  const storedSession=localStorage.getItem('session_id');
  async function pollSession(){
    if(!storedSession) return;
    try{
      const r=await fetch(`/sessions/${encodeURIComponent(storedSession)}/status`);
      if(r.ok){
        const j=await r.json();
        onlineBadge.textContent=j.state==='open' ? (j.jid? `online ¬∑ ${j.jid}`:'online') : j.state;
        setSvcBadge(j.state==='open');
        // Quando conectar, refletir session_id na URL sem recarregar
        if(j.state==='open'){
          const url = new URL(window.location.href);
          if(url.searchParams.get('session_id') !== storedSession){
            url.searchParams.set('session_id', storedSession);
            history.replaceState(null, '', url.toString());
          }
        }
      }
    }catch{}
  }
  pollSession(); setInterval(pollSession,5000);

  // Composer send
  composer.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!currentChat){ toast('Selecione uma conversa','err'); return; }
    const text=(textInput.value||'').trim();
    if(!text) return;
    const optimisticId = pushMsg('out',text); // retorna undefined, mas mantemos classe pending; iremos reconciliar via SSE
    const payload={ session_id: localStorage.getItem('session_id') || '', to: currentChat.id, text, client_ref: optimisticId };
    textInput.value='';
    autoResize(textInput);
    try{
      const r=await fetch('/messages/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(!r.ok){ toast('Falha ao enviar','err'); }
    }catch{ toast('Falha ao enviar','err'); }
  });

  // Auto-resize textarea up to a max height (approx 6 lines)
  function autoResize(el){
    if(!el) return; el.style.height='auto';
    const max=140; // px
    const h=Math.min(el.scrollHeight, max);
    el.style.height=h+'px';
    el.style.overflowY = el.scrollHeight>max ? 'auto':'hidden';
  }
  textInput.addEventListener('input',()=>autoResize(textInput));
  autoResize(textInput);

  // Enter to send (desktop style): Enter sends, Shift+Enter newline
  textInput.addEventListener('keydown',(e)=>{
    if(e.key==='Enter' && !e.shiftKey){
      e.preventDefault();
      // Trigger submit programmatically
      composer.requestSubmit();
    }
  });

  // Nova conversa - abrir modal
  document.getElementById('new-chat').onclick = () => {
    document.getElementById('new-chat-modal').setAttribute('aria-hidden', 'false');
    document.getElementById('phone-input').focus();
  };

  // Fechar modal nova conversa
  document.querySelectorAll('[data-close-new-chat]').forEach(btn => {
    btn.onclick = () => {
      document.getElementById('new-chat-modal').setAttribute('aria-hidden', 'true');
      document.getElementById('new-chat-form').reset();
    };
  });

  // Validar e formatar n√∫mero de telefone
  function formatPhone(input) {
    // Remove tudo exceto n√∫meros
    let numbers = input.replace(/\D/g, '');
    
    // Se come√ßar com 55, √© brasileiro
    if (numbers.startsWith('55') && numbers.length >= 12) {
      return `+55 ${numbers.substr(2,2)} ${numbers.substr(4,5)}-${numbers.substr(9,4)}`;
    }
    
    // Outros pa√≠ses - formato gen√©rico
    if (numbers.length >= 10) {
      return `+${numbers}`;
    }
    
    return input;
  }

  function phoneToJid(phone) {
    // Remove tudo exceto n√∫meros
    const numbers = phone.replace(/\D/g, '');
    
    // Validar se tem pelo menos 10 d√≠gitos
    if (numbers.length < 10) return null;
    
    return `${numbers}@s.whatsapp.net`;
  }

  // Auto-formata√ß√£o e valida√ß√£o em tempo real
  document.getElementById('phone-input').addEventListener('input', (e) => {
    const value = e.target.value.trim();
    const feedback = document.getElementById('phone-validation');
    const createBtn = document.getElementById('create-chat-btn');
    
    if (!value) {
      feedback.style.display = 'none';
      createBtn.disabled = false;
      return;
    }
    
    const validation = validateBrazilianPhone(value);
    feedback.style.display = 'block';
    
    if (validation.valid) {
      feedback.style.color = '#22c55e'; // Verde
      feedback.textContent = `‚úì ${validation.formatted} (${validation.message})`;
      createBtn.disabled = false;
    } else {
      feedback.style.color = '#ef4444'; // Vermelho
      feedback.textContent = `‚úó ${validation.message}`;
      createBtn.disabled = true;
    }
  });

  // Criar nova conversa com valida√ß√£o melhorada
  document.getElementById('new-chat-form').onsubmit = (e) => {
    e.preventDefault();
    
    const phoneInput = document.getElementById('phone-input');
    const phone = phoneInput.value.trim();
    
    if (!phone) {
      toast('Digite um n√∫mero de telefone', 'err');
      return;
    }
    
    // Validar com nova fun√ß√£o
    const validation = validateBrazilianPhone(phone);
    
    if (!validation.valid) {
      toast(validation.message, 'err');
      return;
    }
    
    const jid = `${validation.normalized}@s.whatsapp.net`;
    
    // Mostrar preview do n√∫mero normalizado
    toast(`Criando conversa para: ${validation.formatted}`, 'ok');
    
    // Fechar modal
    document.getElementById('new-chat-modal').setAttribute('aria-hidden', 'true');
    
    // Criar ou abrir conversa
    createNewChat(jid, validation.formatted);
    
    // Reset form
    phoneInput.value = '';
  };

  function createNewChat(jid, displayPhone) {
    // Verificar se j√° existe
    if (chatsMap.has(jid)) {
      selectChat(jid);
      toast('Conversa j√° existe!');
      return;
    }
    
    // Criar nova conversa
    const newChat = {
      id: jid,
      name: jid,
      last: '',
      time: '',
      unread: 0,
      starred: false,
      timestamp: Date.now()
    };
    
    chatsMap.set(jid, newChat);
    messagesByJid.set(jid, []);
    
    // Adicionar nome formatado ao mapa de contatos se n√£o existir
    if (!contactsMap.has(jid)) {
      contactsMap.set(jid, { name: displayPhone, is_group: false });
    }
    
    renderChatList();
    selectChat(jid);
    toast('Nova conversa criada!');
  }

  // Filter chips
  document.querySelectorAll('.s-filters .chip').forEach(chip=>{
    chip.addEventListener('click',()=>{
      document.querySelectorAll('.s-filters .chip').forEach(c=>c.classList.remove('is-active'));
      chip.classList.add('is-active');
      activeFilter = chip.getAttribute('data-filter')||'all';
      renderChatList();
    });
  });

  // Busca real (debounce)
  const searchInput = document.getElementById('search');
  let searchTimer=null;
  if(searchInput){
    searchInput.addEventListener('input', ()=>{
      clearTimeout(searchTimer);
      const q = searchInput.value.trim();
      if(!q){ renderChatList(); return; }
      searchTimer=setTimeout(()=> runSearch(q), 350);
    });
  }
  async function runSearch(q){
    const sessionId = localStorage.getItem('session_id');
    if(!sessionId) return;
    try{
      const r=await fetch(`/sessions/${encodeURIComponent(sessionId)}/search?q=${encodeURIComponent(q)}`);
      if(!r.ok) return;
      const j=await r.json();
      const hits=(j.results||[]).slice(0,50); // limitar
      // mapear hits a chats e reordenar artificialmente
      const now=Date.now();
      hits.forEach((h,i)=>{
        const jid = h.fromMe? (h.to||h.from): h.from;
        if(!messagesByJid.has(jid)) messagesByJid.set(jid, []);
        // adicionar ghost message se n√£o existir
        if(!messagesByJid.get(jid).some(m=>m.id===h.id)){
          messagesByJid.get(jid).push({ id:h.id, text:h.text||'', fromMe:!!h.fromMe, timestamp:h.timestamp||now });
        }
        let chat = chatsMap.get(jid);
        if(!chat){ chat = { id:jid, name:jid, last:h.text?.slice(0,60)||'', time: formatTime(h.timestamp||now), unread:0, starred:false, timestamp: h.timestamp||now }; chatsMap.set(jid, chat); }
        chat.last = h.text?.slice(0,60)||'';
        chat.timestamp = now + (1000 - i); // for√ßa ordenar pelo resultado
        chat.time = formatTime(chat.timestamp);
      });
      renderChatList();
    }catch{}
  }

  // ===== Perfil =====
  const profileBtn=document.getElementById('profile-btn');
  const drwProfile=document.getElementById('drw-profile');
  const pfUser=document.getElementById('pf-user');
  const pfSession=document.getElementById('pf-session');
  const pfPlan=document.getElementById('pf-plan');
  const pfUsageToday=document.getElementById('pf-usage-today');
  const pfQuota=document.getElementById('pf-quota');
  const pfUsageTotal=document.getElementById('pf-usage-total');
  const pfState=document.getElementById('pf-state');
  const pfConn=document.getElementById('pf-conn');
  const pfJid=document.getElementById('pf-jid');
  const pfQRWrap=document.getElementById('pf-qr-wrap');
  const pfQR=document.getElementById('pf-qr');
  const btnConnect=document.getElementById('btn-connect');
  const btnGenerateQR=document.getElementById('btn-generate-qr');
  const btnDisconnect=document.getElementById('btn-disconnect');
  const btnRegen=document.getElementById('btn-regen-qr');
  const btnClean=document.getElementById('btn-clean');
  const btnLogout=document.getElementById('btn-logout');

  let profileTimer=null;
  function showProfile(){ drwProfile.classList.add('show'); loadProfile(); clearInterval(profileTimer); profileTimer=setInterval(loadProfile, 5000); }
  function hideProfile(){ drwProfile.classList.remove('show'); if(profileTimer){ clearInterval(profileTimer); profileTimer=null; } }
  drwProfile?.addEventListener('click', (e)=>{ if(e.target===drwProfile) hideProfile(); });
  document.querySelectorAll('[data-close-profile]').forEach(b=>b.addEventListener('click', hideProfile));
  profileBtn?.addEventListener('click', showProfile);

  let qrPollTimer=null;
  async function pollQR(sessionId){
    clearTimeout(qrPollTimer);
    try {
      const url = sessionId ? `/sessions/${encodeURIComponent(sessionId)}/qr` : '/me/session/qr';
      const r=await fetch(url);
      if(r.ok){ const j=await r.json(); if(j?.dataUrl){ pfQR.src=j.dataUrl; pfQRWrap.style.display='block'; } }
      else if(r.status===404){ pfQRWrap.style.display='none'; }
    }catch{}
    qrPollTimer=setTimeout(()=>pollQR(sessionId), 3000);
  }

  async function loadProfile(){
    try {
      const r=await fetch('/me/profile');
      if(!r.ok){ toast('Falha perfil','err'); return }
      const j=await r.json();
      pfUser.textContent=j.userId;
      pfSession.textContent=j.sessionId;
      pfPlan.textContent=j.plan?.name||'‚Äî';
      pfUsageToday.textContent=j.usage?.messagesToday||0;
      pfQuota.textContent=j.plan?.quotaDaily||0;
      pfUsageTotal.textContent=j.usage?.total||0;
      pfState.textContent=j.session?.state||'‚Äî';
      if(pfConn){ pfConn.textContent = (j.session?.state==='open')? 'ONLINE' : 'OFFLINE'; }
      if(pfJid){
        if(j.session?.jid){ pfJid.textContent = 'Conectado: '+ j.session.jid; }
        else { pfJid.textContent = 'N√£o conectado'; }
      }
      // Persistir session_id para garantir que o restante da UI (SSE, envio) tenha a sess√£o correta
      try {
        if(j.sessionId){
          localStorage.setItem('session_id', j.sessionId);
          // manter chave alternativa (legacy) se algum c√≥digo usa
          if(!localStorage.getItem('sessionId')) localStorage.setItem('sessionId', j.sessionId);
          // Se j√° estiver conectado, refletir session_id na URL
          if((j.session?.state||'')==='open'){
            const url = new URL(window.location.href);
            if(url.searchParams.get('session_id') !== j.sessionId){
              url.searchParams.set('session_id', j.sessionId);
              history.replaceState(null, '', url.toString());
            }
          }
        }
      } catch {}
      const st=j.session?.state;
      // Mostrar bot√µes b√°sicos
      if(st==='open'){
        if(btnConnect) btnConnect.style.display='none';
        if(btnGenerateQR) btnGenerateQR.style.display='none';
        if(btnDisconnect) btnDisconnect.style.display='inline-block';
      } else {
        if(btnConnect) btnConnect.style.display='inline-block';
        if(btnGenerateQR) btnGenerateQR.style.display='inline-block';
        if(btnDisconnect) btnDisconnect.style.display='none';
      }
      const manual = (window.MANUAL_PAIRING === '1');
      btnRegen.style.display = manual && (st!=='open') ? 'inline-block':'none';
      btnClean.style.display = 'inline-block';
      // Exibir/atualizar QR enquanto a sess√£o n√£o estiver aberta
      if(st !== 'open'){ pollQR(j.sessionId) } else { pfQRWrap.style.display='none'; clearTimeout(qrPollTimer); }
    } catch {}
  }

  // A√ß√µes de conex√£o b√°sicas
  btnConnect?.addEventListener('click', async ()=>{
    try{
      const id = localStorage.getItem('session_id') || localStorage.getItem('sessionId') || '';
      if(!id){ toast('Sem sess√£o','err'); return; }
      // Apenas valida status atual; n√£o dispara gera√ß√£o de QR automaticamente.
      toast('Verificando sess√£o...');
      loadProfile();
    }catch{ toast('Erro ao conectar','err'); }
  });
  btnDisconnect?.addEventListener('click', async ()=>{
    try{
      const r=await fetch('/me/session/clean',{method:'POST'});
      if(!r.ok) return toast('Erro ao desconectar','err');
      toast('Sess√£o desconectada');
      loadProfile();
    }catch{ toast('Erro rede','err'); }
  });

  // Gerar QRCode e navegar para a p√°gina dedicada
  btnGenerateQR?.addEventListener('click', async ()=>{
    try{
      const id = localStorage.getItem('session_id') || localStorage.getItem('sessionId') || '';
      if(!id){ toast('Sem sess√£o','err'); return; }
      await fetch('/sessions/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:id})}).catch(()=>{});
      await fetch(`/sessions/${encodeURIComponent(id)}/start`,{method:'POST'}).catch(()=>{});
      try { localStorage.setItem('sessionId', id); localStorage.setItem('session_id', id); } catch {}
      window.location.href = `/qr.html?session_id=${encodeURIComponent(id)}`;
    } catch { toast('Erro ao gerar QR','err'); }
  });

  btnRegen?.addEventListener('click', async ()=>{
    btnRegen.disabled=true; try{ const r=await fetch('/me/session/regen-qr',{method:'POST'}); if(r.ok){ toast('Reiniciando sess√£o'); loadProfile(); } else toast('Erro regen','err'); } finally { btnRegen.disabled=false; }
  });
  btnClean?.addEventListener('click', async ()=>{
    if(!confirm('Desvincular e limpar credenciais?')) return;
    btnClean.disabled=true; try{ const r=await fetch('/me/session/clean',{method:'POST'}); if(r.ok){ toast('Sess√£o limpa'); loadProfile(); } else toast('Erro limpar','err'); } finally { btnClean.disabled=false; }
  });
  btnLogout?.addEventListener('click', async ()=>{
    try { const r=await fetch('/me/logout',{method:'POST'}); } catch {}
    try { localStorage.removeItem('auth'); localStorage.removeItem('sessionId'); localStorage.removeItem('userId'); } catch {}
    location.replace('/login.html');
  });

  // Attachment button behavior (placeholder)
  const attachBtn=document.getElementById('attach');
  if(attachBtn){
    const fileInput=document.createElement('input');
    fileInput.type='file';
    fileInput.style.display='none';
    document.body.appendChild(fileInput);
    attachBtn.addEventListener('click',()=>fileInput.click());
    fileInput.addEventListener('change', async ()=>{
      if(!(currentChat && fileInput.files && fileInput.files[0])) return;
      const f=fileInput.files[0];
      const sessionId = localStorage.getItem('session_id')||'';
      if(!sessionId){ toast('Sem sess√£o','err'); return; }
      // placeholder msg
      const placeholderId = pushMsg('out', `üìé Enviando ${f.name}...`);
      const form = new FormData();
      form.append('session_id', sessionId);
      form.append('to', currentChat.id);
      form.append('file', f);
      try{
        const r=await fetch('/messages/media',{method:'POST', body: form});
        if(!r.ok){ toast('Falha upload','err'); }
        else {
          // A mensagem real chegar√° via SSE; podemos marcar placeholder como enviado
          const el = messagesEl.querySelector(`[data-id="${placeholderId}"]`);
          if(el){ el.classList.remove('pending'); el.textContent = `üìé ${f.name}`; }
        }
      }catch{ toast('Erro rede upload','err'); }
      finally { fileInput.value=''; }
    });
  }

  async function loadInitial(){
    const sessionId = localStorage.getItem('session_id');
    if(!sessionId) return;
    
    // Carregar contatos salvos primeiro
    await loadContacts();
    
    // aguardar at√© estado open (tentativa leve)
    try {
      const st = await fetch(`/sessions/${encodeURIComponent(sessionId)}/status`).then(r=>r.ok?r.json():null);
      if(!st || st.state!=='open'){ /* n√£o bloqueia, ainda assim tenta buscar novas */ }
    } catch {}
    let data=[]; try { const r=await fetch(`/sessions/${encodeURIComponent(sessionId)}/messages?limit=500`); if(r.ok){ const j=await r.json(); data=j.messages||[] } } catch {}
    // Normalizar e agrupar
    data.forEach(m=>{
      const jid = m.fromMe ? (m.to || m.from) : m.from;
      if(!messagesByJid.has(jid)) messagesByJid.set(jid, []);
      messagesByJid.get(jid).push({ id:m.id, text:m.text||'', fromMe:!!m.fromMe, timestamp:m.timestamp||Date.now() });
    });
    // Construir chats
    messagesByJid.forEach((arr,jid)=>{
      const lastMsg = arr.slice().sort((a,b)=>b.timestamp-a.timestamp)[0];
      chatsMap.set(jid, { id: jid, name: jid, last: lastMsg?.text?.slice(0,60)||'', time: formatTime(lastMsg?.timestamp), unread:0, starred:false, timestamp: lastMsg?.timestamp||0 })
    });
    renderChatList();
    // Restaurar √∫ltimo chat
    const restoreId=localStorage.getItem(LS_CHAT_KEY);
    if(restoreId && chatsMap.has(restoreId)) selectChat(restoreId);
  }

  function formatTime(ts){ if(!ts) return ''; const d=new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

  loadInitial();
  renderChatList();
  // ====== Tempo real (SSE) - Passo 2 ======
  let evtSource=null;
  let sseRetry=0;
  function startSSE(){
    const sessionId = localStorage.getItem('session_id');
    if(!sessionId){ return; }
    if(evtSource){ evtSource.close(); }
    const url = `/sessions/${encodeURIComponent(sessionId)}/stream`;
    try {
      evtSource = new EventSource(url);
    } catch (e){ console.warn('SSE init falhou', e); scheduleReconnect(); return; }
    evtSource.onopen = ()=>{ sseRetry=0; console.log('SSE aberto'); };
    evtSource.onerror = (e)=>{ console.warn('SSE erro', e); evtSource && evtSource.close(); scheduleReconnect(); };
    evtSource.onmessage = (e)=>{
      if(!e.data) return;
      let payload; try{ payload=JSON.parse(e.data); }catch{return;}
      handleSSE(payload);
    };
  }
  function scheduleReconnect(){
    sseRetry = Math.min(sseRetry+1, 6); // limite ~6 -> backoff ~32s max
    const delay = Math.min(1000 * Math.pow(2, sseRetry), 30000);
    setTimeout(()=>startSSE(), delay);
  }
  function handleSSE(ev){
    if(ev.type==='ready'){ return; }
    if(ev.type==='contact_upsert'){ // novo contato salvo
      const contact = ev.contact || ev;
      if(contact.jid && contact.name) {
        contactsMap.set(contact.jid, {
          name: contact.name,
          is_group: contact.is_group || false
        });
        // Re-renderizar lista para atualizar nomes se necess√°rio
        renderChatList();
        // Se √© o chat ativo, atualizar cabe√ßalho tamb√©m
        if(currentChat && currentChat.id === contact.jid) {
          peerName.textContent = formatContactName(contact.jid);
        }
      }
      return;
    }
    if(ev.type==='message'){ // nova mensagem
      const m = ev.message || ev;
      const jid = m.fromMe ? (m.to || m.from) : m.from;
      if(!messagesByJid.has(jid)) messagesByJid.set(jid, []);
      // evitar duplicados
      if(!messagesByJid.get(jid).some(x=>x.id===m.id)){
        messagesByJid.get(jid).push({ 
          id:m.id, 
          text:m.text||'', 
          fromMe:!!m.fromMe, 
          timestamp:m.timestamp||Date.now(),
          mediaInfo: m.mediaInfo || null
        });
      }
      // Reconcilia√ß√£o otimista: se mensagem fromMe e possu√≠mos .pending com mesmo texto recente
      if(m.fromMe && currentChat && currentChat.id===jid){
        // procure a √∫ltima .pending cujo texto combine
        const pendings = [...messagesEl.querySelectorAll('.msg.out.pending')];
        for(let i=pendings.length-1;i>=0;i--){
          const el=pendings[i];
          if(el.textContent=== (m.text||'')){ el.classList.remove('pending'); el.setAttribute('data-id', m.id); break; }
        }
      }
      // atualizar chat
      const arr = messagesByJid.get(jid);
      const lastMsg = arr.slice().sort((a,b)=>b.timestamp-a.timestamp)[0];
      let chat = chatsMap.get(jid);
      if(!chat){ chat = { id:jid, name:jid, last:'', time:'', unread:0, starred:false, timestamp:0 }; chatsMap.set(jid, chat); }
      chat.last = lastMsg?.text?.slice(0,60)||'';
      chat.timestamp = lastMsg?.timestamp||Date.now();
      chat.time = formatTime(chat.timestamp);
      // unread se n√£o est√° aberto e mensagem √© inbound
      if(!(currentChat && currentChat.id===jid) && !m.fromMe){ chat.unread = (chat.unread||0)+1; }
      // se chat aberto, render incremental
      if(currentChat && currentChat.id===jid){
        // s√≥ adicionar se n√£o reconciliado (sem elemento com data-id)
        if(!messagesEl.querySelector(`[data-id="${m.id}"]`)){
          pushMsg(m.fromMe?'out':'in', m.text||'', m.id, m.mediaInfo);
        }
      }
      renderChatList();
      return;
    }
    if(ev.type==='message_status'){ // apenas poderia atualizar UI futura (ticks)
      // placeholder: no momento ignorado, mas poder√≠amos alterar classe visual
      return;
    }
  }
  // iniciar SSE ap√≥s pequeno atraso para garantir session_id e hist√≥rico
  setTimeout(startSSE, 800);
  
  // ===== MOBILE INITIALIZATION =====
  // Garantir que mobile sempre comece na view de chats (lista)
  function initializeMobileView() {
    const app = document.getElementById('app');
    const isMobile = window.matchMedia('(max-width:1023px)').matches;
    
    if (isMobile) {
      // Mobile deve sempre come√ßar mostrando lista de chats
      delete app.dataset.view; // Remove data-view="chat" se existir
      
      // Garantir que bot√£o voltar est√° escondido inicialmente
      const backBtn = document.getElementById('back');
      if (backBtn) backBtn.style.display = 'none';
    }
  }
  
  // Executar na inicializa√ß√£o e quando a tela muda de tamanho
  initializeMobileView();
  window.addEventListener('resize', initializeMobileView);
  
  // ==== Modal utilities & feature mocks ====
  function $(s,root=document){return root.querySelector(s)}
  function show(id){ $(id).classList.add('show') }
  function hide(el){ el.classList.remove('show') }
  document.querySelectorAll('.modal [data-close]')?.forEach(b=>b.addEventListener('click',e=>hide(e.target.closest('.modal'))))

  // Open modals
  $('#menu-flow')?.addEventListener('click', ()=>show('#mdl-flow'))
  $('#menu-qr')?.addEventListener('click', ()=>{ showProfile(); })
  $('#menu-schedule')?.addEventListener('click', ()=>show('#mdl-schedule'))
  $('#menu-tags')?.addEventListener('click', ()=>show('#mdl-tags'))

  // ====== Nova l√≥gica QR ======
  function getSessionId(){ return localStorage.getItem('sessionId') || localStorage.getItem('session_id') || '' }
  // Reuso de vari√°veis globais se j√° definidas anteriormente
  if(typeof qrPollTimer==='undefined'){ window.qrPollTimer=null; }
  let qrStatusTimer=null;
  function clearQRTimers(){ if(qrPollTimer) clearTimeout(qrPollTimer); if(qrStatusTimer) clearTimeout(qrStatusTimer); }
  async function fetchStatus(id){ try{ const r=await fetch(`/sessions/${encodeURIComponent(id)}/status`); if(!r.ok) return null; return await r.json(); }catch{ return null } }
  async function fetchQR(){ try{ const r=await fetch('/me/session/qr'); if(!r.ok) return null; const j=await r.json(); return j.dataUrl }catch{ return null } }
  async function ensureSessionCreated(id){ try { await fetch('/sessions/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:id})}) } catch {} }
  async function startManual(id){ try { const r=await fetch(`/sessions/${encodeURIComponent(id)}/start`,{method:'POST'}); return r.ok } catch { return false } }
  function setQRState(s){ const el=document.getElementById('qr-state'); if(el) el.textContent=s||'‚Äî'; }
  function showEl(id,show){ const el=document.getElementById(id); if(el) el.style.display=show? 'block':'none'; }
  async function pollQRImage(){ const imgEl=document.getElementById('qr-image'); const wrap=document.getElementById('qr-image-wrap'); if(!imgEl||!wrap) return; const code=await fetchQR(); if(code){ imgEl.src=code; wrap.style.display='block'; } else { wrap.style.display='none'; } qrPollTimer=setTimeout(pollQRImage,6000); }
  async function pollStatusLoop(){ const id=getSessionId(); if(!id) return; const st=await fetchStatus(id); if(st){ setQRState(st.state); updateQRUIForState(st.state); } qrStatusTimer=setTimeout(pollStatusLoop,5000); }
  function updateQRUIForState(state){ const connected=document.getElementById('qr-connected'); const imgWrap=document.getElementById('qr-image-wrap'); const btnStart=document.getElementById('qr-start'); const btnRegen=document.getElementById('qr-regen'); const btnClean=document.getElementById('qr-clean'); const btnOpenTab=document.getElementById('qr-open-newtab'); const manual = window.MANUAL_PAIRING==='1';
    if(state==='open'){ connected.style.display='block'; imgWrap.style.display='none'; btnStart.style.display='none'; btnRegen.style.display= manual? 'inline-block':'none'; btnClean.style.display='inline-block'; btnOpenTab.style.display='none'; clearTimeout(qrPollTimer); }
    else if(state==='pairing'){ connected.style.display='none'; btnStart.style.display='none'; btnRegen.style.display= manual? 'inline-block':'none'; btnClean.style.display='inline-block'; btnOpenTab.style.display='inline-block'; pollQRImage(); }
    else { // idle / closed / undefined
      connected.style.display='none'; imgWrap.style.display='none'; btnRegen.style.display='none'; btnOpenTab.style.display='none'; btnClean.style.display='inline-block'; btnStart.style.display= manual? 'inline-block':'none'; if(!manual){ // auto criar
          const id=getSessionId(); if(id){ ensureSessionCreated(id); }
        }
    }
  }
  async function openQRModal(){ const modal=document.getElementById('mdl-qr'); if(!modal) return; modal.classList.add('show'); clearQRTimers(); const id=getSessionId(); if(!id){ setQRState('sem sess√£o'); return; } setQRState('carregando...'); const prof = await fetch('/me/profile').then(r=>r.ok?r.json():null).catch(()=>null); const state = prof?.session?.state; if(!state){ await ensureSessionCreated(id); }
    updateQRUIForState(state||'idle'); pollStatusLoop(); if(state==='pairing'){ pollQRImage(); } }
  document.getElementById('qr-start')?.addEventListener('click', async ()=>{ const id=getSessionId(); if(!id) return toast('Sem sess√£o','err'); const ok=await startManual(id); if(!ok) return toast('Falha iniciar','err'); setQRState('pairing'); updateQRUIForState('pairing'); pollQRImage(); })
  document.getElementById('qr-regen')?.addEventListener('click', async ()=>{ const id=getSessionId(); if(!id) return; await fetch(`/sessions/${encodeURIComponent(id)}/qr/regenerate`,{method:'POST'}).catch(()=>{}); toast('Solicitado novo QR'); })
  document.getElementById('qr-clean')?.addEventListener('click', async ()=>{ await fetch('/me/session/clean',{method:'POST'}).catch(()=>{}); toast('Sess√£o limpa'); clearQRTimers(); setQRState('idle'); updateQRUIForState('idle'); })
  document.getElementById('qr-open-newtab')?.addEventListener('click', ()=>{ const id=getSessionId(); if(!id) return; window.open(`/qr.html?session_id=${encodeURIComponent(id)}`,'_blank'); })

  // === Flows (API) ===
  async function createFlow(){
    const name = $('#flow-name')?.value?.trim()||'Fluxo'
    let nodes; try{ nodes = JSON.parse($('#flow-json')?.value || '[]') }catch{ return toast('JSON inv√°lido','err') }
    try {
      const r=await fetch('/flows',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,nodes})})
      if(!r.ok) return toast('Erro ao salvar fluxo','err')
      toast('Fluxo salvo'); hide($('#mdl-flow'))
    } catch { toast('Erro rede','err') }
  }
  $('#flow-save')?.addEventListener('click', createFlow)

  // === Schedules (API) ===
  async function fetchSchedules(){
    try{ const r=await fetch('/schedules'); if(!r.ok) return []; const j=await r.json(); return j.schedules||[] }catch{return []}
  }
  async function renderSchedules(){ const box = $('#sched-list'); if(!box) return; const arr = await fetchSchedules(); box.innerHTML = arr.length? arr.map(s=>`‚Ä¢ ${new Date(s.when).toLocaleString()} ‚Üí ${s.to}: "${s.text}" <span style='opacity:.6'>(${s.status})</span>`).join('<br>') : 'Sem agendamentos.' }
  renderSchedules()
  $('#sched-save')?.addEventListener('click', async ()=>{
  const session_id = localStorage.getItem('sessionId') || localStorage.getItem('session_id') || ''
    const to = $('#sched-to')?.value?.trim()
    const text = $('#sched-text')?.value?.trim()
    const when = $('#sched-when')?.value
    if(!session_id||!to||!text||!when) return toast('Preencha todos os campos','err')
    try{
      const r=await fetch('/schedules',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id,to,text,when})})
      if(!r.ok) return toast('Erro ao agendar','err')
      toast('Agendado')
      renderSchedules()
    }catch{ toast('Erro rede','err') }
  })

  // === Tags (API) ===
  async function fetchTags(){ try{ const r=await fetch('/tags'); if(!r.ok) return {}; const j=await r.json(); return j.tags||{} }catch{return {}} }
  async function renderTags(){ const box = $('#tag-list'); if(!box) return; const t = await fetchTags(); box.innerHTML = Object.keys(t).length? Object.entries(t).map(([k,v])=>`‚Ä¢ ${k}: ${v}`).join('<br>') : 'Sem etiquetas.' }
  renderTags()
  $('#tag-save')?.addEventListener('click', async ()=>{
    const id = $('#tag-msg-id')?.value?.trim()
    const label = $('#tag-label')?.value?.trim()
    if(!id||!label) return toast('Informe id e etiqueta','err')
    try {
      const r=await fetch('/tags',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message_id:id,label})})
      if(!r.ok) return toast('Erro ao etiquetar','err')
      toast('Etiqueta aplicada'); renderTags();
    } catch { toast('Erro rede','err') }
  })

  // toast util fallback
  if(typeof toast!=='function'){
    window.toast = function(msg,type='ok'){
      const t=document.createElement('div');t.className='toast '+type; t.textContent=msg; document.body.appendChild(t);
      requestAnimationFrame(()=>t.classList.add('show')); setTimeout(()=>{t.classList.remove('show'); setTimeout(()=>t.remove(),200)},2500)
    }
  }

  // === Theme Toggle ===
  (function(){
    const btn=document.getElementById('theme-toggle');
    if(!btn) return;
    const root=document.documentElement;
    const KEY='theme_pref';
    function apply(t){ if(t==='light'){ root.setAttribute('data-theme','light'); btn.setAttribute('aria-label','Usar tema escuro'); } else { root.removeAttribute('data-theme'); btn.setAttribute('aria-label','Usar tema claro'); } }
    let pref=localStorage.getItem(KEY);
    if(!pref){
      // auto detect system
      pref=window.matchMedia('(prefers-color-scheme: light)').matches? 'light':'dark';
    }
    apply(pref);
    btn.addEventListener('click',()=>{
      pref = (root.getAttribute('data-theme')==='light')? 'dark':'light';
      localStorage.setItem(KEY,pref);
      apply(pref);
    });
  })();

  // Hamburger dropdown
  (function(){
    const wrap=document.getElementById('hamb-menu');
    const btn=document.getElementById('hamb-btn');
    if(!wrap||!btn) return;
    const toggle=()=>{ const open=wrap.classList.toggle('show'); btn.setAttribute('aria-expanded', String(open)); }
    btn.addEventListener('click', toggle);
    document.addEventListener('click',(e)=>{ if(!wrap.contains(e.target)){ wrap.classList.remove('show'); btn.setAttribute('aria-expanded','false'); } })
  })();
  </script>

  <!-- Fluxo IA -->
  <div class="modal" id="mdl-flow">
    <div class="modal-card">
      <div class="modal-h"><strong>Fluxo IA</strong><button class="m-btn" data-close>‚úï</button></div>
      <div class="modal-b">
        <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap" id="flow-tabs">
          <button type="button" class="chip is-active" data-tab="chatbot">Criar Chatbot</button>
          <button type="button" class="chip" data-tab="iaform">Formul√°rio IA</button>
        </div>
        <div id="tab-chatbot">
          <p class="help">Defina sequ√™ncia de perguntas e respostas do chatbot (estrutura simples).</p>
          <div class="row"><span class="label">Nome</span><input class="input" id="cb-name" placeholder="Ex. Recep√ß√£o"></div>
          <div class="row" style="align-items:flex-start"><span class="label">Blocos</span>
            <div style="flex:1" id="cb-blocks"></div>
          </div>
          <button type="button" class="m-btn" id="cb-add">Adicionar bloco</button>
          <div class="help">Cada bloco: pergunta feita ao cliente e resposta padr√£o ou pr√≥xima a√ß√£o.</div>
        </div>
        <div id="tab-iaform" style="display:none">
          <p class="help">Texto base usado pela IA antes de responder. Complementa a Base de Conhecimento.</p>
          <textarea class="input" id="ia-free" rows="10" placeholder="Insira informa√ß√µes adicionais do neg√≥cio..."></textarea>
          <div class="help">Salve para atualizar o contexto. Use este campo para campanhas, pol√≠ticas tempor√°rias etc.</div>
        </div>
      </div>
      <div class="modal-f" id="flow-actions">
        <button class="m-btn" data-close>Fechar</button>
        <button class="btn" id="flow-save">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Conectar QR (reutiliza sess√£o existente) -->
  <div class="modal" id="mdl-qr">
    <div class="modal-card">
      <div class="modal-h"><strong>Conectar QR</strong><button class="m-btn" data-close>‚úï</button></div>
      <div class="modal-b" style="display:flex;flex-direction:column;gap:12px;">
        <div>Estado: <span id="qr-state">‚Äî</span></div>
        <div id="qr-connected" style="display:none;color:#69e4a6;font-weight:600;">Sess√£o conectada ‚úÖ</div>
        <div id="qr-image-wrap" style="display:none;text-align:center;">
          <img id="qr-image" alt="QR" style="max-width:240px;border:1px solid var(--wa-border);padding:6px;border-radius:8px;background:var(--wa-panel)" />
          <p class="help" style="margin-top:6px;">Escaneie no WhatsApp para conectar.</p>
        </div>
        <div class="help" id="qr-hint">A sess√£o √© ligada ao seu usu√°rio. Reabrir este modal mostra o status atual.</div>
      </div>
      <div class="modal-f" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:space-between;align-items:center;">
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn" id="qr-start" style="display:none;">Iniciar sess√£o</button>
          <button class="btn outline" id="qr-regen" style="display:none;">Regenerar QR</button>
          <button class="btn outline" id="qr-open-newtab" style="display:none;">Abrir em aba</button>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn outline" id="qr-clean" style="display:none;">Desvincular</button>
          <button class="m-btn" data-close>Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Agendar envios -->
  <div class="modal" id="mdl-schedule">
    <div class="modal-card">
      <div class="modal-h"><strong>Agendar envios</strong><button class="m-btn" data-close>‚úï</button></div>
      <div class="modal-b">
        <div class="row"><span class="label">Session ID</span><input class="input" id="sched-session" placeholder="Ex. santemoda-01"></div>
        <div class="row"><span class="label">Para (JID)</span><input class="input" id="sched-to" placeholder="5511999999999@s.whatsapp.net"></div>
        <div class="row"><span class="label">Mensagem</span><input class="input" id="sched-text" placeholder="Texto da campanha"></div>
        <div class="row"><span class="label">Quando</span><input class="input" id="sched-when" type="datetime-local"></div>
        <div class="help">Mock local: salva no localStorage e executa no hor√°rio via setTimeout (enquanto a p√°gina estiver aberta).</div>
        <div id="sched-list" class="help"></div>
      </div>
      <div class="modal-f"><button class="m-btn" data-close>Fechar</button><button class="btn" id="sched-save">Agendar</button></div>
    </div>
  </div>

  <!-- Etiquetar mensagem -->
  <div class="modal" id="mdl-tags">
    <div class="modal-card">
      <div class="modal-h"><strong>Etiquetar mensagem</strong><button class="m-btn" data-close>‚úï</button></div>
      <div class="modal-b">
        <div class="row"><span class="label">ID da msg</span><input class="input" id="tag-msg-id" placeholder="ex. key.id"></div>
        <div class="row"><span class="label">Etiqueta</span><input class="input" id="tag-label" placeholder="Prioridade, VIP, Suporte..."></div>
        <div class="help">Mock: vamos manter um map de etiquetas em localStorage (msgId -> tag).</div>
        <div id="tag-list" class="help"></div>
      </div>
      <div class="modal-f"><button class="m-btn" data-close>Fechar</button><button class="btn" id="tag-save">Aplicar etiqueta</button></div>
    </div>
  </div>

  <!-- Late binding script to ensure modal elements exist -->
  <script>
  (function(){
    // Re-bind close buttons with event delegation (in case initial binding missed due to DOM order)
    document.addEventListener('click', (e)=>{
      const t = e.target;
      if(t && t.matches && t.matches('.modal [data-close]')){
        const modal = t.closest('.modal');
        if(modal) modal.classList.remove('show');
      }
    });

    // Safe query helper (JS only)
  function $(s, r){ return (r||document).querySelector(s); }

    // If earlier listeners failed (elements absent), attach now.
    $('#qr-open')?.getAttribute('data-bound') || $('#qr-open')?.addEventListener('click', async ()=>{
      const el = $('#qr-session');
      const id = localStorage.getItem('sessionId') || localStorage.getItem('session_id') || '';
      if(!id) return toast('Fa√ßa login antes','err');
      try {
        await fetch('/sessions/create',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({session_id:id})});
        window.open(`/qr.html?session_id=${encodeURIComponent(id)}`,'_blank');
      } catch { toast('Erro ao criar sess√£o','err'); }
    });

    $('#flow-save')?.getAttribute('data-bound') || $('#flow-save')?.addEventListener('click', async ()=>{
      // Determine active tab
      const activeTab = document.querySelector('#flow-tabs .chip.is-active')?.getAttribute('data-tab');
      if(activeTab==='chatbot'){
        const nameEl = document.getElementById('cb-name');
        const name = nameEl && nameEl.value ? nameEl.value.trim() : 'Fluxo';
        // Collect blocks
        const blocks = [];
        document.querySelectorAll('.cb-block').forEach((blk,i)=>{
          const qEl = blk.querySelector('[data-q]');
          const aEl = blk.querySelector('[data-a]');
          const q = qEl && qEl.value ? qEl.value.trim() : '';
          const a = aEl && aEl.value ? aEl.value.trim() : '';
          if(q||a){ blocks.push({ id:'b'+i, question:q||'', answer:a||'' }) }
        });
        try{
          const r=await fetch('/flows',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,nodes:blocks})});
          if(!r.ok) return toast('Erro ao salvar fluxo','err');
          toast('Fluxo salvo');
          if(nameEl) nameEl.value='';
          const blkWrap = document.getElementById('cb-blocks');
          if(blkWrap) blkWrap.innerHTML='';
        }catch{ toast('Erro rede','err') }
      } else if(activeTab==='iaform') {
        const extraEl = document.getElementById('ia-free');
        const extra = extraEl && extraEl.value ? extraEl.value : '';
        // Merge with existing knowledge file (append at end under heading)
        try {
          const k= await fetch('/knowledge');
          const base = k.ok? (await k.json()).content : '';
          let updated = base;
          const marker = '\n\n# Extra IA';
          if(base.includes('# Extra IA')){
            updated = base.replace(/(# Extra IA[\s\S]*)$/,'# Extra IA\n'+extra.trim()+"\n");
          } else {
            updated = base.trim()+ marker + '\n'+ extra.trim()+'\n';
          }
          const r=await fetch('/knowledge',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:updated})});
          if(!r.ok) return toast('Erro ao salvar IA','err');
          toast('Contexto IA salvo');
        }catch{ toast('Erro rede','err') }
      }
    });

    $('#sched-save')?.getAttribute('data-bound') || $('#sched-save')?.addEventListener('click', async ()=>{
      const sEl=$('#sched-session'); const toEl=$('#sched-to'); const txtEl=$('#sched-text'); const whenEl=$('#sched-when');
      const session_id = (sEl && sEl.value ? sEl.value.trim() : '') || localStorage.getItem('session_id') || '';
      const to = toEl && toEl.value ? toEl.value.trim() : '';
      const text = txtEl && txtEl.value ? txtEl.value.trim() : '';
      const when = whenEl && whenEl.value ? whenEl.value : '';
      if(!session_id||!to||!text||!when) return toast('Preencha todos os campos','err');
      try{ const r=await fetch('/schedules',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id,to,text,when})}); if(!r.ok) return toast('Erro ao agendar','err'); toast('Agendado'); }catch{ toast('Erro rede','err') }
    });

    $('#tag-save')?.getAttribute('data-bound') || $('#tag-save')?.addEventListener('click', async ()=>{
      const idEl=$('#tag-msg-id'); const labelEl=$('#tag-label');
      const id = idEl && idEl.value ? idEl.value.trim() : '';
      const label = labelEl && labelEl.value ? labelEl.value.trim() : '';
      if(!id||!label) return toast('Informe id e etiqueta','err');
      try{ const r=await fetch('/tags',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message_id:id,label})}); if(!r.ok) return toast('Erro ao etiquetar','err'); toast('Etiqueta aplicada'); }catch{ toast('Erro rede','err') }
    });

    // Menu open bindings safeguard (in case earlier script ran too early somehow)
    $('#menu-flow')?.addEventListener('click', ()=>$('#mdl-flow')?.classList.add('show'))
  $('#menu-qr')?.addEventListener('click', showProfile)
    $('#menu-schedule')?.addEventListener('click', ()=>$('#mdl-schedule')?.classList.add('show'))
    $('#menu-tags')?.addEventListener('click', ()=>$('#mdl-tags')?.classList.add('show'))

    // Tabs handling
    const tabs=document.getElementById('flow-tabs');
    tabs?.addEventListener('click',(e)=>{
      const t=e.target;
      if(!(t && t.closest)) return;
      const chip = t.closest('.chip');
      if(!chip) return;
      tabs.querySelectorAll('.chip').forEach(c=>c.classList.remove('is-active'));
      chip.classList.add('is-active');
      const tab = chip.getAttribute('data-tab');
      const tabChat = document.getElementById('tab-chatbot');
      const tabIA = document.getElementById('tab-iaform');
      if(tabChat) tabChat.style.display = tab==='chatbot'? 'block':'none';
      if(tabIA) tabIA.style.display = tab==='iaform'? 'block':'none';
      if(tab==='iaform') loadIAExtra();
    });

    // Chatbot block builder
    function addBlock(q='',a=''){
      const wrap=document.createElement('div');
      wrap.className='cb-block';
      wrap.style.cssText='border:1px solid var(--wa-border);padding:10px;border-radius:10px;margin-bottom:8px;display:flex;flex-direction:column;gap:6px;background:var(--wa-panel)';
      wrap.innerHTML=`<input data-q class="input" placeholder="Pergunta" value="${q}" />\n<textarea data-a class="input" rows="2" placeholder="Resposta"></textarea>\n<button type="button" class="m-btn cb-del">Remover</button>`;
      const del = wrap.querySelector('.cb-del'); if(del) del.addEventListener('click',()=>wrap.remove());
      const ans = wrap.querySelector('[data-a]'); if(ans) ans.value=a;
      const blocksContainer=document.getElementById('cb-blocks');
      if(blocksContainer) blocksContainer.appendChild(wrap);
    }
    document.getElementById('cb-add')?.addEventListener('click',()=>addBlock());

    // Load IA extra section into textarea
    async function loadIAExtra(){
      try{
        const r=await fetch('/knowledge'); if(!r.ok) return;
        const j=await r.json();
        const match = j.content.match(/# Extra IA[\r\n]+([\s\S]*)$/);
        const iaFree = document.getElementById('ia-free');
        if(iaFree) iaFree.value = match? match[1].trim():'';
      }catch{}
    }
  })();
  </script>
  
  <script src="/virtual-scroller.js"></script>
  <script src="/lazy-loader.js"></script>
  <script src="/api-batch-manager.js"></script>
  <script src="/mobile-gestures.js"></script>
  <script src="/push-notifications.js"></script>
  
  <script>
    // Service Worker Registration  
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('/sw.js', {
            scope: '/'
          })
          
          console.log('‚úÖ Service Worker registrado:', registration.scope)
          
          // Escutar mensagens do SW
          navigator.serviceWorker.addEventListener('message', event => {
            const { type, data } = event.data
            
            if (type === 'message-sent') {
              console.log('üì§ Mensagem enviada via background sync:', data)
              // Atualizar UI se necess√°rio
            }
          })
          
        } catch (error) {
          console.error('‚ùå Erro ao registrar Service Worker:', error)
        }
      })
    }
    
    // PWA Install Banner
    let deferredPrompt
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault()
      deferredPrompt = e
      
      // Mostrar bot√£o de instala√ß√£o customizado
      const installBanner = document.createElement('div')
      installBanner.className = 'install-banner'
      installBanner.innerHTML = `
        <div class="install-content">
          <span>üì± Instalar ZapSan como app?</span>
          <button onclick="installPWA()" class="install-btn">Instalar</button>
          <button onclick="dismissInstallBanner()" class="dismiss-btn">√ó</button>
        </div>
      `
      
      document.body.insertBefore(installBanner, document.body.firstChild)
    })
    
    async function installPWA() {
      if (deferredPrompt) {
        deferredPrompt.prompt()
        const result = await deferredPrompt.userChoice
        
        if (result.outcome === 'accepted') {
          console.log('‚úÖ PWA instalado')
        }
        
        deferredPrompt = null
        dismissInstallBanner()
      }
    }
    
    function dismissInstallBanner() {
      const banner = document.querySelector('.install-banner')
      if (banner) banner.remove()
    }
    
    // Integra√ß√£o otimiza√ß√µes m√≥veis no app principal
    document.addEventListener('DOMContentLoaded', () => {
      // Virtual scrolling para listas de mensagens
      const messagesList = document.querySelector('.messages-list')
      if (messagesList && window.VirtualMessageScroller) {
        const virtualScroller = new VirtualMessageScroller(messagesList, {
          itemHeight: 65,
          renderAhead: 15,
          enableInfiniteScroll: true,
          onLoadMore: async (offset, limit) => {
            // Carregar mais mensagens da API
            try {
              const response = await window.api.get(`/messages?offset=${offset}&limit=${limit}`)
              return response.messages || []
            } catch {
              return []
            }
          }
        })
      }

      // Lazy loading autom√°tico para imagens
      if (window.lazyLoader) {
        // Re-scan quando novo conte√∫do for adicionado
        const observer = new MutationObserver(() => {
          window.lazyLoader.scanAndSetup()
        })
        observer.observe(document.body, { childList: true, subtree: true })
      }

      // Otimizar API calls com batching
      if (window.api) {
        // Substituir fetch global para usar sistema de batch
        const originalFetch = window.fetch
        window.fetch = function(url, options = {}) {
          // Use batch system para GET requests
          if (!options.method || options.method === 'GET') {
            return window.api.get(url, options)
          }
          
          // Use batch system para POST requests
          if (options.method === 'POST' && options.body) {
            try {
              const body = JSON.parse(options.body)
              return window.api.post(url, body, options)
            } catch {
              return originalFetch(url, options)
            }
          }
          
          // Fallback para outros casos
          return originalFetch(url, options)
        }
      }

      // Gestures m√≥veis
      if (window.MobileGestureHandler) {
        const gestureHandler = new MobileGestureHandler(document.body)
        
        // Pull to refresh
        gestureHandler.onPullToRefresh = () => {
          location.reload()
        }
        
        // Swipe navigation
        gestureHandler.onSwipeLeft = () => {
          const nextButton = document.querySelector('.nav-next')
          if (nextButton) nextButton.click()
        }
        
        gestureHandler.onSwipeRight = () => {
          const prevButton = document.querySelector('.nav-prev')
          if (prevButton) prevButton.click()
        }
      }

      // Performance monitoring
      if ('performance' in window) {
        setTimeout(() => {
          const stats = {
            virtualScroller: window.VirtualMessageScroller?.getGlobalStats?.() || {},
            lazyLoader: window.lazyLoader?.getStats?.() || {},
            apiBatcher: window.apiBatcher?.getStats?.() || {}
          }
          
          console.log('üìä Performance Stats:', stats)
        }, 5000)
      }

      // üìû SISTEMA DE CONTATOS - Inicializa√ß√£o
      initContactSystem()
    })

  // === SISTEMA DE CONTATOS ===
  function initContactSystem() {
    // Event listeners para navega√ß√£o
    const contactsNavItem = document.querySelector('[data-nav="contacts"]')
    contactsNavItem?.addEventListener('click', (e) => {
      e.preventDefault()
      openContactsModal()
    })

    // Event listeners dos modais
    setupContactModalEvents()
    setupContactFormEvents()
  }

  function setupContactModalEvents() {
    const modal = document.getElementById('contacts-modal')
    const closeBtn = modal.querySelector('[data-close-contacts]')
    const searchInput = document.getElementById('contact-search')
    const addBtn = document.getElementById('add-contact-btn')
    const importBtn = document.getElementById('import-contacts-btn')
    const exportBtn = document.getElementById('export-contacts-btn')

    // Fechar modal
    closeBtn?.addEventListener('click', () => closeModal('contacts-modal'))
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) closeModal('contacts-modal')
    })

    // Busca de contatos
    searchInput?.addEventListener('input', (e) => {
      renderContactsList(e.target.value)
    })

    // Adicionar contato
    addBtn?.addEventListener('click', () => openContactForm())

    // Importar contatos
    importBtn?.addEventListener('click', () => {
      document.getElementById('import-file-input').click()
    })

    // Exportar contatos
    exportBtn?.addEventListener('click', () => exportContacts())

    // Input de arquivo
    const fileInput = document.getElementById('import-file-input')
    fileInput?.addEventListener('change', (e) => {
      if (e.target.files[0]) {
        importContacts(e.target.files[0])
        e.target.value = '' // Reset input
      }
    })
  }

  function setupContactFormEvents() {
    const modal = document.getElementById('contact-form-modal')
    const form = document.getElementById('contact-form')
    const closeBtn = modal.querySelector('[data-close-contact-form]')
    const saveBtn = document.getElementById('save-contact-btn')

    // Fechar modal
    closeBtn?.addEventListener('click', () => closeModal('contact-form-modal'))
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) closeModal('contact-form-modal')
    })

    // Salvar contato
    saveBtn?.addEventListener('click', () => saveContact())
    form?.addEventListener('submit', (e) => {
      e.preventDefault()
      saveContact()
    })
  }

  function openContactsModal() {
    document.getElementById('contacts-modal').setAttribute('aria-hidden', 'false')
    renderContactsList()
    updateContactStats()
  }

  function openContactForm(contact = null) {
    const modal = document.getElementById('contact-form-modal')
    const title = document.getElementById('contact-form-title')
    const form = document.getElementById('contact-form')
    
    if (contact) {
      title.textContent = 'Editar Contato'
      document.getElementById('contact-name').value = contact.name
      document.getElementById('contact-phone').value = contact.phone
      document.getElementById('contact-tags').value = contact.tags.join(', ')
      document.getElementById('contact-notes').value = contact.notes || ''
      form.dataset.editPhone = contact.phone
    } else {
      title.textContent = 'Adicionar Contato'
      form.reset()
      delete form.dataset.editPhone
    }
    
    modal.setAttribute('aria-hidden', 'false')
    document.getElementById('contact-name').focus()
  }

  function closeModal(modalId) {
    document.getElementById(modalId).setAttribute('aria-hidden', 'true')
  }

  function renderContactsList(searchQuery = '') {
    const contacts = searchQuery 
      ? contactManager.searchContacts(searchQuery)
      : contactManager.getAllContacts()
    
    const container = document.getElementById('contacts-list')
    const emptyState = document.getElementById('contacts-empty')
    
    if (contacts.length === 0) {
      emptyState.style.display = 'block'
      container.innerHTML = ''
      container.appendChild(emptyState)
      return
    }
    
    emptyState.style.display = 'none'
    
    container.innerHTML = contacts.map(contact => `
      <div class="contact-item" style="display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--wa-border); gap: 12px;">
        <div class="contact-avatar" style="width: 40px; height: 40px; border-radius: 50%; background: var(--wa-accent); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0;">
          ${contact.name.charAt(0).toUpperCase()}
        </div>
        <div class="contact-info" style="flex: 1; min-width: 0;">
          <div class="contact-name" style="font-weight: 600; margin-bottom: 2px;">${contact.name}</div>
          <div class="contact-phone" style="font-size: 0.9rem; color: var(--muted); margin-bottom: 2px;">${formatPhoneForDisplay(contact.phone)}</div>
          ${contact.tags.length ? `<div class="contact-tags" style="font-size: 0.8rem;">${contact.tags.map(tag => `<span style="background: var(--wa-accent); color: white; padding: 2px 6px; border-radius: 10px; margin-right: 4px;">${tag}</span>`).join('')}</div>` : ''}
          ${contact.notes ? `<div class="contact-notes" style="font-size: 0.85rem; color: var(--muted); margin-top: 4px;">${contact.notes}</div>` : ''}
        </div>
        <div class="contact-actions" style="display: flex; gap: 8px;">
          <button type="button" class="icon-btn" onclick="openContactForm(contactManager.getContact('${contact.phone}'))" title="Editar">‚úèÔ∏è</button>
          <button type="button" class="icon-btn" onclick="deleteContact('${contact.phone}')" title="Excluir" style="color: #e74c3c;">üóëÔ∏è</button>
        </div>
      </div>
    `).join('')
  }

  function updateContactStats() {
    const stats = contactManager.getStats()
    document.getElementById('stats-total').textContent = stats.total
    document.getElementById('stats-notes').textContent = stats.withNotes
    document.getElementById('stats-tags').textContent = stats.tags.length
  }

  function saveContact() {
    const form = document.getElementById('contact-form')
    const name = document.getElementById('contact-name').value.trim()
    const phone = document.getElementById('contact-phone').value.trim()
    const tags = document.getElementById('contact-tags').value.split(',').map(t => t.trim()).filter(Boolean)
    const notes = document.getElementById('contact-notes').value.trim() || undefined
    
    if (!name || !phone) {
      toast('Nome e telefone s√£o obrigat√≥rios', 'err')
      return
    }
    
    try {
      contactManager.addContact(phone, name, tags, notes)
      toast('Contato salvo com sucesso!', 'ok')
      closeModal('contact-form-modal')
      renderContactsList()
      updateContactStats()
    } catch (error) {
      toast('Erro ao salvar contato: ' + error.message, 'err')
    }
  }

  function deleteContact(phone) {
    if (confirm('Deseja realmente excluir este contato?')) {
      if (contactManager.removeContact(phone)) {
        toast('Contato exclu√≠do com sucesso!', 'ok')
        renderContactsList()
        updateContactStats()
      } else {
        toast('Erro ao excluir contato', 'err')
      }
    }
  }

  async function importContacts(file) {
    try {
      const result = await contactManager.importFromFile(file)
      
      if (result.success > 0) {
        toast(`${result.success} contatos importados com sucesso!`, 'ok')
        renderContactsList()
        updateContactStats()
      }
      
      if (result.errors.length > 0) {
        console.warn('Erros na importa√ß√£o:', result.errors)
        toast(`Importa√ß√£o conclu√≠da com ${result.errors.length} erros. Verifique o console.`, 'warn')
      }
    } catch (error) {
      toast('Erro ao importar contatos: ' + error.message, 'err')
    }
  }

  function exportContacts() {
    try {
      const csv = contactManager.exportContacts()
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' })
      const link = document.createElement('a')
      
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob)
        link.setAttribute('href', url)
        link.setAttribute('download', `contatos-zapsan-${new Date().toISOString().split('T')[0]}.csv`)
        link.style.visibility = 'hidden'
        document.body.appendChild(link)
        link.click()
        document.body.removeChild(link)
        
        toast('Contatos exportados com sucesso!', 'ok')
      }
    } catch (error) {
      toast('Erro ao exportar contatos: ' + error.message, 'err')
    }
  }

  function formatPhoneForDisplay(phone) {
    // Formato: +55 (98) 99999-9999
    if (phone.startsWith('55') && phone.length >= 12) {
      const ddd = phone.substring(2, 4)
      const number = phone.substring(4)
      const part1 = number.substring(0, number.length - 4)
      const part2 = number.substring(number.length - 4)
      return `+55 (${ddd}) ${part1}-${part2}`
    }
    return phone
  }

  // Integra√ß√£o com lista de chats - Mostrar nome dos contatos
  function getDisplayName(jid) {
    const phone = jid.split('@')[0] // Remove @s.whatsapp.net
    return contactManager.getContactName(phone)
  }
  </script>
</body>
</html>