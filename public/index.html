<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Santê Console</title>
  <link rel="stylesheet" href="/styles.css" />
  <script>(function(){try{const a=localStorage.getItem('auth')==='ok';const onL=location.pathname.endsWith('/login.html');if(!a&&!onL){location.replace('/login.html');}if(a&&onL){location.replace('/');}}catch(e){}})();</script>
</head>
<body>
  <header class="topbar"><div class="topbar-inner">
    <div class="brand">Santê Console</div>
    <div class="badge" id="svc-badge">Carregando…</div>
  </div></header>

  <div class="app" id="app">
    <aside class="sidebar">
      <div class="s-header">
        <div class="brand" style="font-size:15px">Conversas</div>
        <div class="actions"><button class="icon-btn" id="new-chat">＋</button></div>
      </div>
      <div class="s-search"><input class="input" id="search" placeholder="Pesquisar conversas…"></div>
      <div class="s-filters">
        <button class="chip is-active" data-filter="all">Todos</button>
        <button class="chip" data-filter="unread">Não lidas</button>
        <button class="chip" data-filter="starred">Com estrela</button>
      </div>
      <div class="chat-list" id="chat-list"></div>
    </aside>

    <section class="chat">
      <div class="c-header">
        <div class="peer">
          <button class="icon-btn" id="back" style="display:none">←</button>
          <div class="avatar"></div>
          <div class="meta">
            <div class="name" id="peer-name">Selecione uma conversa</div>
            <div class="status" id="online-badge">—</div>
          </div>
        </div>
        <div class="actions">
          <button class="icon-btn" id="chat-search">🔍</button>
          <button class="icon-btn" id="chat-info">ℹ️</button>
        </div>
      </div>
      <div class="c-messages" id="messages"></div>
      <form class="c-composer" id="composer">
        <button type="button" class="icon-btn" id="attach">📎</button>
        <input class="input" id="text" placeholder="Escreva uma mensagem…" autocomplete="off" />
        <button class="btn" id="send">Enviar</button>
      </form>
    </section>
  </div>

  <script>
  // Util toast
  function toast(msg,type='ok'){
    const t=document.createElement('div');
    t.className='toast '+type;
    t.textContent=msg;
    document.body.appendChild(t);
    requestAnimationFrame(()=>t.classList.add('show'));
    setTimeout(()=>{t.classList.remove('show'); setTimeout(()=>t.remove(),200)},2500);
  }

  // Mock conversas
  const chats=[
    { id:'5511999990001@s.whatsapp.net', name:'Loja Centro', last:'Pedido #123 preparado', time:'09:12' },
    { id:'5511999990002@s.whatsapp.net', name:'Cliente VIP', last:'Pode enviar a NF?', time:'Ontem' },
    { id:'5511999990003@s.whatsapp.net', name:'Fornecedor', last:'Entrega confirmada', time:'Seg' }
  ];
  let currentChat=null;
  const app=document.getElementById('app');
  const listEl=document.getElementById('chat-list');
  const messagesEl=document.getElementById('messages');
  const peerName=document.getElementById('peer-name');
  const onlineBadge=document.getElementById('online-badge');
  const backBtn=document.getElementById('back');
  const svcBadge=document.getElementById('svc-badge');
  const textInput=document.getElementById('text');
  const composer=document.getElementById('composer');

  function renderChatList(){
    listEl.innerHTML='';
    chats.forEach(c=>{
      const item=document.createElement('div');
      item.className='chat-item';
      item.innerHTML=`<div class="avatar"></div><div class="meta"><div class="name">${c.name}</div><div class="last">${c.last}</div></div><div class="time">${c.time}</div>`;
      item.onclick=()=>selectChat(c);
      listEl.appendChild(item);
    });
  }

  function selectChat(c){
    currentChat=c;
    peerName.textContent=c.name;
    messagesEl.innerHTML='';
    // mock initial messages
    const seed=[
      {dir:'in', text:'Olá, em que posso ajudar?'},
      {dir:'out', text:'Quero detalhes do pedido.'},
      {dir:'in', text:'Claro! Pedido #123 sai hoje.'}
    ];
    seed.forEach(m=>pushMsg(m.dir,m.text));
    if(window.matchMedia('(max-width:1023px)').matches){
      app.dataset.view='chat';
      backBtn.style.display='inline-block';
    }
    scrollBottom();
  }

  function pushMsg(dir,text){
    const el=document.createElement('div');
    el.className='msg '+(dir==='out'?'out':'in');
    el.textContent=text;
    messagesEl.appendChild(el);
    scrollBottom();
  }
  function scrollBottom(){ messagesEl.scrollTop=messagesEl.scrollHeight; }

  backBtn.onclick=()=>{
    delete app.dataset.view;
    backBtn.style.display='none';
  };

  // Health status
  async function refreshHealth(){
    try{
      const r=await fetch('/health');
      if(r.ok){svcBadge.textContent='Online';svcBadge.style.background='#0f1a16';svcBadge.style.color='#9be3c2';}
      else {svcBadge.textContent='Offline';svcBadge.style.background='#3a1a1a';svcBadge.style.color='#fca5a5';}
    }catch{svcBadge.textContent='Offline';svcBadge.style.background='#3a1a1a';svcBadge.style.color='#fca5a5';}
  }
  refreshHealth(); setInterval(refreshHealth,15000);

  // Session status polling
  const storedSession=localStorage.getItem('session_id');
  async function pollSession(){
    if(!storedSession) return;
    try{
      const r=await fetch(`/sessions/${encodeURIComponent(storedSession)}/status`);
      if(r.ok){
        const j=await r.json();
        onlineBadge.textContent=j.state==='open'?'online':j.state;
      }
    }catch{}
  }
  pollSession(); setInterval(pollSession,5000);

  // Composer send
  composer.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!currentChat){ toast('Selecione uma conversa','err'); return; }
    const text=(textInput.value||'').trim();
    if(!text) return;
    pushMsg('out',text);
    const payload={ session_id: localStorage.getItem('session_id') || '', to: currentChat.id, text };
    textInput.value='';
    try{
      const r=await fetch('/messages/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(!r.ok){ toast('Falha ao enviar','err'); }
    }catch{ toast('Falha ao enviar','err'); }
  });

  // New chat just demonstrates toast
  document.getElementById('new-chat').onclick=()=>toast('Funcionalidade futura');

  renderChatList();
  </script>
</body>
</html>